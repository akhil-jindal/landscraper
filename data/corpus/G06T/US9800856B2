Systems and methods for synthesizing images from image data captured by an array camera using restricted depth of field depth maps in which depth estimation precision varies 
US-9800856-B2
Fotonation Cayman Limited
2017-10-24
https://patents.google.com/patent/US9800856B2/en
CROSS-REFERENCE TO RELATED APPLICATION
The present invention is a continuation of U.S. patent application Ser. No. 14/207,254 entitled âSystems and Methods for Synthesizing Images from Image Data Captured by an Array Camera Using Restricted Depth of Field Depth Maps in which Depth Estimation Precision Variesâ to Venkataraman et al., filed Mar. 12, 2014, which application claims priority under 35 U.S.C. Â§119(e) to U.S. Provisional Patent Application Ser. No. 61/780,974 entitled âSystems and Methods for Synthesizing Images from Image Data Captured by an Array Camera using Depth Maps in which Depth Estimation Precision and Spatial Resolution Varyâ to Venkataraman et al., filed Mar. 13, 2013, the disclosures of which are incorporated by reference herein in their entirety.
FIELD OF THE INVENTION
The present invention generally relates to digital cameras and more specifically to systems and methods for capturing video and images using array cameras.
BACKGROUND
Binocular viewing of a scene creates two slightly different images of the scene due to the different fields of view of each eye. These differences, referred to as binocular disparity (or parallax), provide information that can be used to calculate depth in the visual scene, providing a major means of depth perception. The impression of depth associated with stereoscopic depth perception can also be obtained under other conditions, such as when an observer views a scene with only one eye while moving. The observed parallax can be utilized to obtain depth information for objects in the scene. Similar principles in machine vision can be used to gather depth information.
Two cameras separated by a distance can take pictures of the same scene and the captured images can be compared by shifting the pixels of two or more images to find parts of the images that match. The amount an object shifts between two different camera views is called the disparity, which is inversely proportional to the distance to the object. A disparity search that detects the shift of an object in the multiple images that results in the best match can be used to calculate the distance to the object based upon the baseline distance between the cameras and the focal length of the cameras involved (as well as knowledge of additional properties of the camera). The approach of using two or more cameras to generate stereoscopic three-dimensional images is commonly referred to as multi-view stereo.
More recently, researchers have used multiple cameras spanning a wider synthetic aperture to capture light field images (e.g. the Stanford Multi-Camera Array). A light field, which is often defined as a 4D function characterizing the light from all directions at all points in a scene, can be interpreted as a two-dimensional (2D) collection of 2D images of a scene. Due to practical constraints, it is typically difficult to simultaneously capture the collection of 2D images of a scene that form a light field. However, the closer in time at which the image data is captured by each of the cameras, the less likely that variations in light intensity (e.g. the otherwise imperceptible flicker of fluorescent lights) or object motion will result in time dependent variations between the captured images. Processes involving capturing and resampling a light field can be utilized to simulate cameras with large apertures. For example, an array of MÃN cameras pointing at a scene can simulate the focusing effects of a lens as large as the array. In many embodiments, cameras need not be arranged in a rectangular pattern and can have configurations including circular configurations and/or any arbitrary configuration appropriate to the requirements of a specific application. Use of camera arrays in this way can be referred to as synthetic aperture photography.
The larger the aperture of a camera, the more light that is admitted, but the depth of field is reduced. Objects are well focused at a distance determined by the focal length of the camera lens. Objects at other distances are imaged as a blur, sometimes called the circle of confusion. If the object lies far enough from the imager plane that the circle of confusion is larger than some nominal diameter (called maximum acceptable circle of confusion, representing the blur size for which the image is acceptably sharp and typically defined as the size of one pixel in the camera's sensor), the object can be referred to as outside the depth of field for the current camera's settings. Depth of field is defined as the distance between the nearest and farthest objects in the scene for which the circle of confusion is less than the maximum acceptable value. Introducing an aperture stop (diaphragm) into such an optical system and partially closing it reduces the effective diameter of the lens. This reduces the circle of confusion for objects off the plane of best focus, hence increasing the camera's depth of field. Conversely, opening the diaphragm expands the circle of confusion, decreasing depth of field. If the aperture is made extremely large (e.g. as wide as the distance to the plane of best focus), the depth of field becomes so shallow that only objects lying on the plane of best focus are sharp. When an object lying outside the depth of field is small enough that for every point on the plane of best focus, at least some of its rays still reach the lens, the object no longer obscures the camera's view of these points.
SUMMARY OF THE INVENTION
Systems and methods in accordance with embodiments of the invention generate a restricted depth of field depth map from a reference viewpoint using a set of images captured from different viewpoints, where depth estimation precision is higher for pixels with depth estimates within the range of distances corresponding to the restricted depth of field and lower for pixels with depth estimates outside of the range of distances corresponding to the restricted depth of field. In a number of embodiments, restricted depth of field depth maps are utilized to render a video sequence from a set of video sequences captured from different viewpoints.
One embodiment of the invention includes a processor and memory containing a set of images captured from different viewpoints and an image processing pipeline application. In addition, the image processing pipeline application configures the processor to: determine a desired focal plane distance and a range of distances corresponding to a restricted depth of field for an image rendered from a reference viewpoint; generate a restricted depth of field depth map from the reference viewpoint using the set of images captured from different viewpoints, where depth estimation precision is higher for pixels with depth estimates within the range of distances corresponding to the restricted depth of field and lower for pixels with depth estimates outside of the range of distances corresponding to the restricted depth of field; and render a restricted depth of field image from the reference viewpoint using the set of images captured from different viewpoints and the restricted depth of field depth map.
In a further embodiment, the image processing pipeline application further configures the processor to automatically determine the desired focal plane distance and the range of distances corresponding to a restricted depth of field.
In another embodiment, the image processing pipeline application further configures the processor to automatically determine the desired focal plane distance and the range of distances corresponding to the restricted depth of field by determining a distance to a surface of a scene object using the set of images captured from different viewpoints.
In a still further embodiment, the image processing pipeline application further configures the processor to determine a distance to a surface of a scene object using the set of images captured from different viewpoints by: generating an initial depth map and a confidence map from at least a portion of the set of images captured from different viewpoints, where the confidence map indicates the reliability of pixel depth estimates in the initial depth map; and determining the depth of the surface of the scene object based upon at least one pixel depth estimate within the initial depth map marked as confident within the confidence map.
In still another embodiment, the image processing pipeline application further configures the processor to receive a user instruction identifying a surface of a scene object by: generating a preview image from the set of images captured from different viewpoints, where the preview image includes a user interface cue; and identifying a surface of a scene object visible within the set of images captured from different viewpoints based upon the location of the user interface cue.
In a yet further embodiment, the image processing pipeline application further configures the processor to automatically determine the range of distances corresponding to the restricted depth of field based upon the desired focal plane distance.
In yet another embodiment, the image processing pipeline application further configures the processor to determine the range of distances corresponding to the restricted depth of field based upon user instructions.
In a further embodiment again, each image in the set of images captured from different viewpoints forms part of a video sequence in a set of video sequences captured from different viewpoints, and the image processing pipeline application further configures the processor to determine a distance to a surface of a scene object using the set of images captured from different viewpoints by tracking an object over time within the frames of the set of video sequences captured from different viewpoints.
In another embodiment again, the image processing pipeline application further configures the processor to determine a distance to a surface of a scene object using the set of images captured from different viewpoints by selecting a previous object distance when a tracked object is occluded.
In a further additional embodiment, the image processing pipeline application further configures the processor to determine a distance to a surface of a scene object using the set of images captured from different viewpoints by performing time based filtering to smooth variations over time in the desired focal plane distance relative to variations in the distance to the surface of the scene object.
In another additional embodiment, the image processing pipeline application further configures the processor to generate a restricted depth of field depth map by: generating an initial depth map using the set of images captured from different viewpoints; determining pixel locations with depth estimates from the initial depth map indicating that the pixel locations are likely to have depths within the range of distances corresponding to the restricted depth of field; generating higher depth estimation precision depth estimates for at least some of the pixel locations that are likely to have depths within the range of distances corresponding to the restricted depth of field using the set of images captured from different viewpoints; and generating a restricted depth of field depth map using at least some of the depth estimates from the initial depth map and at least some of the higher depth estimation precision depth estimates.
In a still yet further embodiment, the image processing pipeline application further configures the processor to generate an initial depth map by: downsampling at least some of the images in the set of images captured from different viewpoints to obtain a set of lower spatial resolution images; and determining a low spatial resolution depth map using the set of lower spatial resolution images.
In still yet another embodiment, the image processing pipeline application further configures the processor to determine a low spatial resolution depth map using the set of lower spatial resolution images by performing a disparity search with respect to a given pixel location using the set of lower spatial resolution images. In addition, the disparity search is performed by searching a first set of disparities.
In a still further embodiment again, the image processing pipeline application further configures the processor to generate the higher precision depth estimates by performing a disparity search with respect to a given pixel location using the set of images captured from different viewpoints. In addition, the disparity search is performed by searching a second set of disparities, and a search performed using the second set of disparities provides greater depth estimation precision within the range of distances corresponding to the restricted depth of field than the precision of a depth estimate obtained within the same range of distances by a search performed using the first set of disparities.
In still another embodiment again, the image processing pipeline application further configures the processor to perform a disparity search with respect to a given pixel location using the set of images captured from different viewpoints by searching at least one range of disparities within the second set of disparities. In addition, the range of disparities searched is determined based upon the depth estimates in the initial depth map for pixel locations within a neighborhood of the given pixel location.
In a still further additional embodiment, the image processing pipeline application further configures the processor to generate an initial confidence map for the initial depth map. In addition the range of disparities searched is determined based upon confident depth estimates in the initial depth map for pixel locations within a neighborhood of the given pixel location.
In still another additional embodiment, the first set of disparities is not uniformly distributed with respect to disparity.
In a yet further embodiment again, the first set of disparities is uniformly distributed with respect to disparity.
In yet another embodiment again, the second set of disparities is not uniformly distributed with respect to disparity.
In a yet further additional embodiment, the second set of disparities is uniformly distributed with respect to disparity.
In yet another additional embodiment, the image processing pipeline application further configures the processor to generate an initial depth map by performing a disparity search with respect to a given pixel location using the set of images captured from different viewpoints. In addition, the disparity search is performed by searching a first set of disparities.
In a further additional embodiment again, the image processing pipeline application further configures the processor to generate depth estimates for at least some of the pixel locations determined to be likely within the range of distances corresponding to the restricted depth of field at a higher depth estimation precision than the depth estimates for the pixel locations in the initial depth map using the set of images captured from different viewpoints by performing a disparity search with respect to a given pixel location using the set of images captured from different viewpoints. In addition, the disparity search is performed by searching a second set of disparities; and a search performed using the second set of disparities provides greater depth estimation precision within the range of distances corresponding to the restricted depth of field than the precision of a depth estimate obtained within the same range of distances by a search performed using the first set of disparities.
In another additional embodiment again, the first set of disparities is not uniformly distributed with respect to disparity.
In a still yet further embodiment again, the first set of disparities is uniformly distributed with respect to disparity.
In still yet another embodiment again, the second set of disparities is not uniformly distributed with respect to disparity.
In a still yet further additional embodiment, the second set of disparities is uniformly distributed with respect to disparity.
In still yet another additional embodiment, the image processing pipeline application further configures the processor to perform a disparity search with respect to a given pixel location using the set of images captured from different viewpoints by searching a range of disparities within the second set of disparities. In addition, the range of disparities searched is determined based upon the depth estimates in the initial depth map for pixel locations within a neighborhood of the given pixel location.
In a still further additional embodiment again, the image processing pipeline application further configures the processor to generate an initial confidence map for the initial depth map. In addition, the range of disparities searched is determined based upon confident depth estimates in the initial depth map for pixel locations within a neighborhood of the given pixel location.
In another further embodiment, the image processing pipeline application further configures the processor to: generate an initial confidence map for the initial depth map; and determine pixel locations with depth estimates from the initial depth map indicating that the pixel locations are likely to have depths within the range of distances corresponding to the restricted depth of field based upon the depth estimate for the pixel location in the initial depth map and the confidence of the depth estimate for the pixel location indicated by the initial confidence map.
In still another further embodiment, the image processing pipeline application further configures the processor to determine pixel locations with depth estimates from the initial depth map indicating that the pixel locations are likely to have depths within the range of distances corresponding to the restricted depth of field based upon the depth estimate for the pixel location and a determination that the pixel is not contained within a textureless region.
In yet another further embodiment, the image processing pipeline application further configures the processor to generate a restricted depth of field depth map by performing a disparity search with respect to a given pixel location using the set of images captured from different viewpoints. In addition, the disparity search is performed using a greater density of depth samples within the range of distances corresponding to the restricted depth of field and a lower density of depth samples for distances outside the range of distances corresponding to the restricted depth of field.
In another further embodiment again, the image processing pipeline application further configures the processor to render a restricted depth of field image from the reference viewpoint using the set of images captured from different viewpoints and the restricted depth of field depth map by: compositing pixels from the set of images captured from different viewpoints having depth estimates outside the range of distances corresponding to the restricted depth of field by applying scene dependent geometric corrections determined based upon the depth estimates of the composited pixels in the restricted depth of field depth map; and performing super-resolution processing using pixels from the set of images captured from different viewpoints having depth estimates within the range of distances corresponding to the restricted depth of field to synthesize portions of the rendered image at a spatial resolution that is greater than the spatial resolution of the individual images in the set of images captured from different viewpoints.
In another further additional embodiment, the image processing pipeline application further configures the processor to perform super-resolution processing by: performing fusion of pixels from the set of images captured from different viewpoints having depth estimates within the range of distances corresponding to the restricted depth of field to obtain a set of fused pixels by applying scene dependent geometric corrections determined based upon the depth estimates of the fused pixels in the restricted depth of field depth map; and interpolating the set of fused pixels to achieve increases in spatial resolution.
In still yet another further embodiment, the super-resolution processing synthesizes portion of the rendered image at a spatial resolution that is greater than the spatial resolution of the individual images in the set of images captured from different viewpoints by a super-resolution factor; and depth estimation precision for pixels with depth estimates within the range of distances corresponding to the restricted depth of field is at least a precision with respect to disparity corresponding to the spatial resolution of the pixels of at least one of the images in the set of images captured from different viewpoints divided by the super-resolution factor.
In still another further embodiment again, the image processing pipeline application further configures the processor to generate a restricted depth of field depth map by generating an initial depth map using the set of images captured from different viewpoints by: downsampling at least some of the images in the set of images captured from different viewpoints to obtain a set of lower spatial resolution images; and determining a low spatial resolution depth map using the set of lower spatial resolution images. In addition, generating a restricted depth of field depth map includes: determining pixel locations with depth estimates from the initial depth map indicating that the pixel locations are likely to have depths within the range of distances corresponding to the restricted depth of field; generating higher depth estimation precision depth estimates for at least some of the pixel locations that are likely to have depths within the range of distances corresponding to the restricted depth of field using the set of images captured from different viewpoints; and generating a restricted depth of field depth map using at least some of the depth estimates from the initial depth map and at least some of the higher depth estimation precision depth estimates. Furthermore, the image processing pipeline application further configures the processor to composite pixels from the set of images captured from different viewpoints and pixels from the set of lower spatial resolution images by applying scene dependent geometric corrections to the pixels from the set of lower spatial resolution images determined based upon the depth estimates in the initial depth map.
In still another further additional embodiment, the set of images captured from different viewpoints comprises a plurality of subsets of images captured from different viewpoints in a plurality of different color channels. In addition, the image processing pipeline application further configures the processor to render a restricted depth of field image from the reference viewpoint using the set of images captured from different viewpoints and the restricted depth of field depth map by: rendering images from each of the plurality of different color channels using the restricted depth of field depth map; and compositing the rendered image from each of the plurality of different color channels to form a full color reduced depth of field image.
In yet another further embodiment again, the reference viewpoint is a virtual viewpoint.
In yet another further additional embodiment, the restricted depth of field depth map comprises multiple ranges of distances that each correspond to a restricted depth of field.
Another further additional embodiment again includes: an array of cameras configured to capture image data forming a set of images captured from different viewpoints; a processor; and memory containing an image processing pipeline application. In addition the image processing pipeline application configures the processor to: capture a set of images captured from different viewpoints using the array of cameras; store the set of images captured from different viewpoints in memory; determine a desired focal plane distance and a range of distances corresponding to a restricted depth of field for an image rendered from a reference viewpoint; generate a restricted depth of field depth map from the reference viewpoint using the set of images captured from different viewpoints, where depth estimation precision is higher for pixels with depth estimates within the range of distances corresponding to the restricted depth of field and lower for pixels with depth estimates outside of the range of distances corresponding to the restricted depth of field; and render a restricted depth of field image from the reference viewpoint using the set of images captured from different viewpoints and the restricted depth of field depth map.
Still yet another further embodiment again also includes a display. In addition, the image processing pipeline application further configures the processor to generate a preview image from the set of images captured from different viewpoints and display the preview image via the display.
In still yet another further additional embodiment, the display provides a touch user interface, and the image processing pipeline application further configures the processor to determine a desired focal plane distance based upon a touch gesture received via the touch user interface during the display of the preview image.
In yet another further additional embodiment again, at least one of the cameras in the array of cameras includes an autofocus module configured to determine an autofocus distance, and the image processing pipeline application configures the processor to determine a desired focal plane distance based upon the autofocus distance.
In still yet another further embodiment again, the array of cameras includes a Ï filter group comprising and a 3Ã3 array of cameras including: a reference camera at the center of the 3Ã3 array of cameras; two red color cameras located on opposite sides of the 3Ã3 array of cameras; two blue color cameras located on opposite sides of the 3Ã3 array of cameras; and four green color cameras surrounding the reference camera.

BRIEF DESCRIPTION OF THE DRAWINGS
 FIG. 1 is a block diagram of an array camera in accordance with an embodiment of the invention.
 FIG. 2 conceptually illustrates an optic array and an imager array in an array camera module in accordance with an embodiment of the invention.
 FIG. 3 conceptually illustrates a layout of color filters and the location of a reference camera in an array camera module in accordance with an embodiment of the invention.
 FIGS. 4A-4C conceptually illustrate the disparity associated with the effects of parallax in two images of a scene captured from a reference viewpoint and an alternate viewpoint.
 FIG. 5 is a chart illustrating the effect of object distance within a sampled scene on disparity and on depth of field when the focal depth is located at the object distance.
 FIG. 6 is a flow chart illustrating a process for synthesizing images using depth maps that determine disparity with varying levels of precision and varying resolution in accordance with embodiments of the invention.
 FIG. 7 is a flow chart illustrating a video processing pipeline in accordance with an embodiment of the invention.
 FIG. 8 is a flow chart illustrating a process for determining a focal depth and depth of field based upon a selected region of interest in accordance with an embodiment of the invention.
 FIG. 9 is a flow chart illustrating a process for generating a depth map and confidence map in a region of interest and determining a plane of best focus within the region of interest in accordance with an embodiment of the invention.
 FIG. 10 is a flow chart illustrating a process for determining a plane of best focus based upon confident depths of objects within a region of interest in accordance with an embodiment of the invention.
 FIG. 11A illustrates a region of interest within a portion of an image captured by a Green camera within an array camera.
 FIG. 11B illustrates a depth map for the region of interest shown in FIG. 11A.
 FIG. 11C illustrates an edge map for the region of interest shown in FIG. 11A.
 FIG. 11D is a chart showing a histogram of depth values for pixels within the region of interest shown in FIG. 11A.
 FIG. 12 conceptually illustrates the selection of a focal depth and depth of field when capturing image data using an array camera in accordance with embodiments of the invention.
 FIG. 13 is a flow chart illustrating a process for selecting disparities to search during the creation of a depth map based upon a selected focus depth and depth of field in accordance with an embodiment of the invention.
 FIG. 14 conceptually illustrates pixel locations searched along an epipolar line corresponding to depths within a selected depth of field when determining depth in accordance with embodiments of the invention.
 FIG. 15 conceptually illustrates pixel locations searched along an epipolar line corresponding to depths within a selected depth of field and locations corresponding to depths outside the selected depth of field when determining depth in accordance with embodiments of the invention.
 FIG. 16 is a flow chart illustrating a process for generating restricted depth of field depth maps by compositing depth maps generated using downsampled image data captured from a reference viewpoint and from alternate viewpoints in accordance with an embodiment of the invention.
 FIG. 17 conceptually illustrates pixel locations within a downsampled image searched along an epipolar line when determining depth in accordance with an embodiment of the invention.
 FIG. 18A is a flow chart illustrating a process for determining the depth to assign to a pixel based upon a plurality of depth maps having different resolutions in accordance with an embodiment of the invention.
 FIG. 18B is a flow chart illustrating a process for propagating depth estimates from coarser spatial resolution depth maps to higher spatial resolution depth maps based upon the values of the lower spatial resolution depth estimates in accordance with an embodiment of the invention.
 FIG. 18C conceptually illustrates a first coarse precision disparity search (optionally) performed using downsampled images.
 FIG. 18D conceptually illustrates a second higher precision disparity search performed within (at least) a range of distances corresponding to a restricted depth of field.
 FIG. 19 is a flow chart illustrating a process for applying depths determined from downsampled images to selected regions of higher resolution images in accordance with embodiments of the invention.
 FIG. 20 is a flow chart illustrating a process for rendering pixels having an associated depth that is outside the selected depth of field in accordance with an embodiment of the invention.
 FIG. 21 is a flow chart illustrating a process for rendering pixels having an associated depth that is within the selected depth of field in accordance with an embodiment of the invention.

DETAILED DISCLOSURE OF THE INVENTION
Turning now to the drawings, systems and methods for synthesizing images from image data captured by an array camera using restricted depth of field depth maps in accordance with embodiments of the invention are illustrated. The term restricted depth of field depth map can be used to describe a depth map in which precision of depth estimates and/or spatial resolution of depth estimates may vary based upon characteristics of the scene including (but not limited to) object distance and object characteristics. The terms depth and distance, when used to describe the depth or distance of a pixel (as expressed in a depth map or restricted depth of field depth map), typically refers to the distance to an imaged object within a scene along an axis extending from the array camera to the object. Therefore, every object located on a plane perpendicular to the axis extending from the array camera can be considered to have the same depth or distance from the array camera (despite each point on the plane technically having a different Euclidian distance from the array camera). The term depth estimation precision can be used to collectively encompass the precision with which depth is estimated (e.g. the number of disparities sampled to obtain a depth estimate and/or the spacing of the disparity samples at the estimated depth) and the spatial resolution with which depth is estimated (e.g. a depth estimate based upon a 16Ã16 block of pixels may have lower precision with respect to an individual pixel location within the 16Ã16 block than estimating depth with the same precision for each pixel individually). Therefore, restricted depth of field depth maps can be considered to be depth maps in which depth estimation precision varies based upon characteristics of the scene visible from the viewpoint of the cameras in the array camera. Array cameras including camera modules that can be utilized to capture image data from different viewpoints (i.e. light field images) are disclosed in U.S. patent application Ser. No. 12/935,504 entitled âCapturing and Processing of Images using Monolithic Camera Array with Heterogeneous Imagersâ to Venkataraman et al. and U.S. Provisional Patent Application Ser. No. 61/904,947 entitled âArray Camera Modules and Methods of Manufacturing Array Camera Modules Incorporating Independently Aligned Lens Stacksâ to Rodda et al. In many instances, fusion and super-resolution processes such as those described in U.S. patent application Ser. No. 12/967,807 entitled âSystems and Methods for Synthesizing High Resolution Images Using Super-Resolution Processesâ to Lelescu et al., can be utilized to synthesize a higher resolution 2D image or a stereo pair of higher resolution 2D images from the lower resolution images in the light field captured by an array camera. The terms high or higher resolution and low or lower resolution are used here in a relative sense and not to indicate the specific resolutions of the images captured by the array camera. The disclosures of U.S. patent application Ser. No. 12/935,504, U.S. Provisional Patent Application Ser. No. 61/904,947, and U.S. patent application Ser. No. 12/967,807 are hereby incorporated by reference in their entirety.
Each two-dimensional (2D) image in a captured light field is from the viewpoint of one of the cameras in the array camera. Due to the different viewpoint of each of the cameras, parallax results in variations in the position of objects within the images of the scene. Processes such as those disclosed in U.S. Provisional Patent Application No. 61/691,666 entitled âSystems and Methods for Parallax Detection and Correction in Images Captured Using Array Camerasâ to Venkataraman et al. can be utilized to provide an accurate account of the pixel disparity as a result of parallax between the different cameras in an array. The disclosure of U.S. Patent Application Ser. No. 61/691,666 is hereby incorporated by reference in its entirety. Array cameras can use disparity between pixels in images within a light field to generate a depth map from a reference viewpoint. A depth map indicates the distance of the surfaces of scene objects from the reference viewpoint and can be utilized to determine scene dependent geometric corrections to apply to the pixels from each of the images within a captured light field to eliminate disparity when performing fusion and/or super-resolution processing.
Capturing still images or video in real or near-real time can impose considerable processing and power demands on an array camera. One capability of array cameras with short focal lengths is that they can create high resolution images synthesized from captured lower resolution image data using super-resolution processes, where the super-resolved scene is rendered almost entirely in focus. To generate such an all-in-focus image, the image data which is captured from the array is used to form a depth map, the depth map is used to register the individual images in the array and fuse a high quality super-resolved image, and the super-resolution processing takes additional steps to recover resolution or reduce artifacts in the image. In this normal all-in-focus mode, the same processing occurs regardless of the depths of the objects in the scene. In several embodiments of the invention, a compromise can be made to reduce the computational requirements of synthesizing a satisfactory image or video. Instead of rendering a final image which is âall-in-focus,â a synthetic effect is generated which mimics the depth-of-field effects of a larger aperture camera.
In a number of embodiments, a depth map is first calculated and examined, and objects in the image which are sufficiently far away from the desired depth of best focus (i.e. objects located at âout-of-focus depthsâ) are rendered to be blurred in an amount proportional to their distance from the plane of best focus. Regions of the image where objects are sufficiently near to the plane of best focus (i.e. within the range of âin-focus depthsâ) are rendered with sufficient precision so that they appear to be in focus when fused to synthesize a higher resolution image. In many embodiments, for these super-resolved regions of the image, the depth is estimated with precision at least as high (or higher) than the precision of a high resolution grid used for performing super-resolution processing. For example, to achieve super-resolution using a 3Ã resolution grid in the in-focus regions (i.e. to increase the effective number of pixels in the image by a factor of 3), the disparity between objects in the various low resolution cameras would typically be detected to a precision of at least â pixel or higher. The in-focus and out-of-focus regions synthesized above are combined into a single final output image. The aesthetic result of this effect is an image that appears to have a reduced depth-of-field which, though restricted compared to the all-in-focus image, mimics the depth-of-field and focus behavior effects of a larger aperture camera and/or a camera with a longer hyperfocal distance. In many embodiments, the method can be used to blur anything closer than a particular distance (i.e. everything beyond a specified distance can be rendered in focus).
Reducing depth of field can provide certain computational savings. Relaxed sharpness constraints allow the parallax search process to search fewer disparities in the ranges of disparities corresponding to out-of-focus depths, because multiple images do not have to be precisely registered in order to generate a blurred output. In the case that a region of the image is out-of-focus, it is sufficient to detect that the region is at an out-of-focus depth, and only then, to relatively coarse precision. The images need only be matched precisely enough that color banding does not appear when different color channels (e.g. the R, G, and B color channels) are combined in the blurred out-of-focus region during rendering. Additionally, the depths of out-of-focus pixels can be detected at reduced spatial resolution (i.e. using the result of a depth search in reduced resolution images) to save computation. Furthermore, the ability to tolerate blur in the out-of-focus regions can enable the use of less computationally complex rendering (or fusion) processes to synthesize the out-of-focus regions in the final image.
In the in-focus regions, though a high resolution, high precision search is performed to generate high precision depth estimates at a high spatial resolution, the number of depths searched can be reduced to remove depths which are out-of-focus and/or to constrain the depth search based upon the depths of pixels in the neighborhood of the in-focus pixel, where the depth so pixels in the neighborhood may have been calculated at other depth estimation precisions. This means that computational resources are directed towards high precision depth estimation with respect to depths which are to be rendered in-focus, and not across out-of-focus depths where the extra high precision depth estimation does not result in an improved final image since the out-of-focus regions are blurred in the final image. Similarly, super-resolution processes including (but not limited to) processes similar to those disclosed in U.S. patent application Ser. No. 12/967,807 need only be applied to synthesize high resolution in-focus image data. In several embodiments of the invention, captured image data is processed to synthesize a preview image and one or more regions of interest that can be used to define one or more desired depths of best focus.
In a number of embodiments, the array camera includes auto focus capabilities and the desired depth is determined using the autofocus module of the array camera. In several embodiments, a user can select a region of interest and can provide specific parameters which specify how wide the in-focus depth range should be about the desired best focus point (i.e. the range of the restricted depth of field) and how rapidly the blurring should be increased at depths which are increasingly farther away from the plane of best focus (i.e., such parameters essentially define the desired restricted depth of field effect delivered in the final image). In a number of embodiments, the parameter may be a synthetic F# setting and the blur applied as a rapid or not rapidly increasing function of depth (depending on the F#). In several embodiments, the parameter may specify or indicate a blur profile that may or may not be physically realizable by a traditional camera system. In a number of embodiments, a desired plane of best focus for an image is determined by constructing a depth map within the selected region of interest. A map which indicates which pixels in the region of interest are likely to yield confident depths may also be calculated within the same region-of-interest. In a number of embodiments, confidence can be determined based upon a high signal to noise ratio (SNR). In certain embodiments, edge maps can also be utilized to determine pixels for which confident depths can be determined. In other embodiments, any of a variety of techniques can be utilized to determine pixels that can be used with confidence to determine a desired plane of best focus. In several embodiments, the region of interest is automatically and/or continuously monitored or tracked during video capture and time based filtering can be utilized to avoid rapid jumps in the plane of best focus and/or to determine the plane of best focus in circumstances in which a plane of best focus cannot be reliably determined from a single frame. A depth map within a region of interest can be constructed by determining disparity between pixels from the region of interest in image data captured from a reference viewpoint, which may be a virtual viewpoint, and corresponding pixels from image data captured from one or more alternate viewpoints. The most confident pixels in the depth map corresponding to the region of interest can be examined to determine the depth of the object contained within the region of interest. Processes for automatically determining a plane of best focus are described further below. In another embodiment, the plane of best focus is not determined automatically, but is determined manually based on user input. The expected blur for depths other than the best focus depth can be defined based on additional blur parameters that can be predefined and/or provided via the user interface. The resulting focal depth and depth of field can then be used to define at which depths in the final image greater sharpness constraints will apply and at which depths higher levels of blur will be rendered. In a number of embodiments the resulting focal depth and depth of field can be utilized to determine image capture settings based upon the image data captured by pixels having depths falling within the range of distances corresponding to the restricted depth of field.
In the parallax stage, a single restricted depth of field depth map is calculated from the input images. In this case, the single restricted depth of field depth map can be the same size as the resolution of a single camera input (hereafter, the term âL0â is used to signify that the final depth map or any image or data is the same resolution as an input image from a camera in the array). The parallax stage incorporates knowledge of the desired plane of best focus to reduce the computation required to form the final restricted depth of field depth map. A variety of techniques can be utilized to construct the final restricted depth of field depth map from image data captured using an array camera. The process of constructing the final restricted depth of field depth map can include, for selected pixels, searching a greater density of pixel locations along epipolar lines where the disparity corresponds to depths falling within a range of in-focus depths, and reducing number and/or density of the disparities searched that correspond to depths falling in the out-of-focus region. Although much of the discussion that follows refers to in-focus depths and out-of-focus depths, many embodiments of the invention treat transition depths outside a specified restricted depth of field in the same, or a similar, manner as in-focus depths to avoid artifacts. Therefore, the term in-focus depths should be understood to include depths outside the restricted depth of field in many implementations of the invention. In many embodiments, a hierarchy or pyramid of images is formed from the L0 input images, which are filtered and downsampled one or more times to create lower resolution versions of the L0 input images. Each level of lower resolution can be denoted by an increasing number. For example, the highest spatial resolution images are denoted L0, the next lower resolution images denoted as L1, and so forth. In one embodiment, images are calculated corresponding to each resolution level (L0, L1, L2, etc.) by filtering and downscaling the images from the previous (next-highest) resolution level to create the hierarchy of images. In one embodiment, depth maps are calculated at each resolution level using the corresponding images from that spatial resolution level, and the final depth map draws selected pixels from the different resolution depth maps to create a final combined depth map. For example, the L0 images are used for a disparity search to generate an L0 depth map, the L1 images are used for a disparity search to generate an L1 depth map, etc. To generate the final depth map (which may also be L0-sized), some pixels are drawn from the L0 depth map, some from the L1 depth map, and some from the L2 depth map according to a variety of criteria. In another embodiment, to save computations, all depths are calculated at the lowest or lower resolution levels first, but only certain pixels for which the low resolution depths are deemed unreliable or which are determined to belong to in-focus regions which require higher precision of depth estimation are calculated at the highest or higher resolution level(s) to improve the quality of the synthesized image in these regions. In many embodiments, lower precision depths generated using the lower resolution images can be utilized to modify and/or bound the higher precision disparity search performed using the higher resolution images. For example, a higher precision depth estimate can be obtained by performing a disparity search within a predetermined range of disparities relative to the disparity corresponding to a lower precision depth estimate. In several embodiments, a search is performed within a bounded range of disparities determined based upon the lower precision depth estimates of pixels in a neighborhood of the pixel location for which a higher precision depth estimate is sought. In many embodiments, a search is performed at multiple different ranges of disparities determined based upon the lower precision depth estimates of pixels in a neighborhood of the pixel location for which a higher precision depth estimate is sought. In other embodiments, any of a variety of techniques for generating restricted depth of field depth maps with depth estimation precision that varies with object distance can be utilized as appropriate to the requirements of specific applications.
In a number of embodiments, the final restricted depth of field depth map is used to synthesize images from the captured image data. As can be readily appreciated, the higher the spatial resolution and also precision of depth estimation of the depth map, the greater the accuracy with which pixels captured from different viewpoints can be assembled (i.e. fused) to synthesize a final high resolution image. During fusion, the rendering stage can use knowledge of which depths are rendered out-of-focus to reduce computation. If a region of the image is determined to be out-of-focus based on the restricted depth of field depth map, there is no need to fuse data from multiple cameras, because a high resolution rendering (i.e. super-resolution) is not required to generate the blurred out-of-focus region. A much less computationally expensive method can be used in such regions. In regions which are determined to be in-focus, the high quality fusion is used to ensure the highest quality rendering and maximum resolution in these regions, so the resulting rendering appears properly âin-focus.â Systems and methods for synthesizing images from image data captured by array cameras using restricted depth of field depth maps to provide synthetic depth of field effects in accordance with embodiments of the invention are discussed further below.
Array Cameras
Array cameras in accordance with embodiments of the invention can include a camera module including an array of cameras and a processor configured to read out and process image data from the camera module to synthesize images. An array camera in accordance with an embodiment of the invention is illustrated in FIG. 1. The array camera 100 includes a camera module 102 with an array of individual cameras 104 where an array of individual cameras refers to a plurality of cameras in a particular arrangement, such as (but not limited to) the square arrangement utilized in the illustrated embodiment. The camera module 102 is connected to the processor 106. The processor is also configured to communicate with one or more different types of memory 108 that can be utilized to store image data and/or contain machine readable instructions utilized to configure the processor to perform processes including (but not limited to) the various processes described below.
Processors 108 in accordance with many embodiments of the invention can be implemented using a microprocessor and/or a coprocessor configured using appropriate software to take the image data within the light field and synthesize one or more high resolution images. In several embodiments, the high resolution image is synthesized from a reference viewpoint, typically that of a reference focal plane 104 within the sensor 102. In many embodiments, the processor is able to synthesize an image from one or more virtual viewpoints, which do not correspond to the viewpoints of any of the focal planes 104 in the sensor 102. Unless all of the objects within a captured scene are a significant distance from the array camera, the images in the light field will include disparity due to the different fields of view of the focal planes used to capture the images. Processes for detecting and correcting for disparity are discussed further below. Although a specific array camera architecture is illustrated in FIG. 1, alternative architectures can also be utilized in accordance with embodiments of the invention.
Array Camera Modules
Array camera modules in accordance with embodiments of the invention can be constructed from an imager array or sensor including an array of focal planes and an optic array including a lens stack for each focal plane in the imager array. Sensors including multiple focal planes are discussed in U.S. patent application Ser. No. 13/106,797 entitled âArchitectures for System on Chip Array Camerasâ, to Pain et al., the disclosure of which is incorporated herein by reference in its entirety. Light filters can be used within each optical channel formed by the lens stacks in the optic array to enable different cameras within an array camera module to capture image data with respect to different portions of the electromagnetic spectrum.
An array camera module in accordance with an embodiment of the invention is illustrated in FIG. 2. The array camera module 200 includes an imager array 230 including an array of focal planes 240 along with a corresponding optic array 210 including an array of lens stacks 220. Within the array of lens stacks, each lens stack 220 creates an optical channel that forms an image of the scene on an array of light sensitive pixels within a corresponding focal plane 240. Each pairing of a lens stack 220 and focal plane 240 forms a single camera 104 within the camera module. Each pixel within a focal plane 240 of a camera 104 generates image data that can be sent from the camera 104 to the processor 108. In many embodiments, the lens stack within each optical channel is configured so that pixels of each focal plane 240 sample the same object space or region within the scene. In several embodiments, the lens stacks are configured so that the pixels that sample the same object space do so with sub-pixel offsets to provide sampling diversity that can be utilized to recover increased resolution through the use of super-resolution processes.
In the illustrated embodiment, the focal planes are configured in a 5Ã5 array. Each focal plane 240 on the sensor is capable of capturing an image of the scene. Typically, each focal plane includes a plurality of rows of pixels that also forms a plurality of columns of pixels, and each focal plane is contained within a region of the imager that does not contain pixels from another focal plane. In many embodiments, image data capture and readout of each focal plane can be independently controlled. In this way, image capture settings including (but not limited to) the exposure times and analog gains of pixels within a focal plane can be determined independently to enable image capture settings to be tailored based upon factors including (but not limited to) a specific color channel and/or a specific portion of the scene dynamic range. The sensor elements utilized in the focal planes can be individual light sensing elements such as, but not limited to, traditional CIS (CMOS Image Sensor) pixels, CCD (charge-coupled device) pixels, high dynamic range sensor elements, multispectral sensor elements and/or any other structure configured to generate an electrical signal indicative of light incident on the structure. In many embodiments, the sensor elements of each focal plane have similar physical properties and receive light via the same optical channel and color filter (where present). In other embodiments, the sensor elements have different characteristics and, in many instances, the characteristics of the sensor elements are related to the color filter applied to each sensor element.
In several embodiments, color filters in individual cameras can be used to pattern the camera module with Ï filter groups as further discussed in U.S. Provisional Patent Application No. 61/641,165 entitled âCamera Modules Patterned with pi Filter Groupsâ filed May 1, 2012, the disclosure of which is incorporated by reference herein in its entirety. These cameras can be used to capture data with respect to different colors, or a specific portion of the spectrum. In contrast to applying color filters to the pixels of the camera, color filters in many embodiments of the invention are included in the lens stack. For example, a Green color camera can include a lens stack with a Green light filter that allows Green light to pass through the optical channel. In many embodiments, the pixels in each focal plane are the same and the light information captured by the pixels is differentiated by the color filters in the corresponding lens stack for each filter plane. Although a specific construction of a camera module with an optic array including color filters in the lens stacks is described above, camera modules including Ï filter groups can be implemented in a variety of ways including (but not limited to) by applying color filters to the pixels of the focal planes of the camera module similar to the manner in which color filters are applied to the pixels of a conventional color camera. In several embodiments, at least one of the cameras in the camera module can include uniform color filters applied to the pixels in its focal plane. In many embodiments, a Bayer filter pattern is applied to the pixels of one of the cameras in a camera module. In a number of embodiments, camera modules are constructed in which color filters are utilized in both the lens stacks and on the pixels of the imager array.
Although specific array cameras and imager arrays are discussed above, many different array cameras can be utilized to capture image data and synthesize images using restricted depth of field depth maps as appropriate to the requirements of specific applications in accordance with embodiments of the invention. Imager arrays in accordance with embodiments of the invention are discussed further below.
Capturing Image Data with Subsets of Active Cameras
Active cameras in an array camera module in accordance with embodiments of the invention can be grouped into subsets for capturing image data. In many embodiments, a single 3Ã3 Ï filter group is used to capture image data from which frames of video are synthesized. A 4Ã4 array camera module including a subset of active cameras configured to capture image data used to synthesize an image from the viewpoint of a reference camera in accordance with an embodiment of the invention is illustrated in FIG. 3. The 4Ã4 camera module 300 includes a first subset 302 of 3Ã3 active cameras patterned using a Ï filter group and utilized to capture image data that can be utilized to synthesize color images and/or video sequences. In the illustrated embodiment, a Ï filter group includes a Green camera at each corner, a Green reference camera in the center indicated by a box 304, Blue cameras above and below the reference camera, and Red cameras to the left and right sides of the reference camera. In several embodiments, the locations of the Red and Blue cameras within the Ï filter group are swapped and/or an alternative collection of cameras can be utilized to capture image data to synthesize images. In various embodiments, a second subset 306 of active cameras includes a row of Blue, Green, and Red cameras placed below the Ï filter group and a column of Blue, Green, and Red cameras placed to the right side of the Ï filter group with a Green camera connecting the row and the column. In various embodiments, the second subset of active cameras is configured to capture image data for measuring scene information as is described in U.S. Patent Application Ser. No. 61/775,395 entitled âSystems and Methods for Measuring Scene Information While Capturing Images Using Array Camerasâ filed Mar. 8, 2013, the disclosure of which is hereby incorporated by reference in its entirety. Although only a subset of the cameras in the array camera module illustrated in FIG. 3 are shown as capturing image data for use in synthesizing video, in many embodiments more cameras than a single Ï filter group are used to capture image data from which video can be synthesized. Processes for synthesizing video from image data captured using an array camera module in accordance with embodiments of the invention are discussed further below.
Determining Parallax/Disparity
In a number of embodiments, the individual cameras in the array camera module used to capture a light field have similar fields of view, fixed apertures, and focal lengths. Parallax in a two camera system is illustrated in FIG. 4A. The two cameras 200, 202, include a lens stack 204 and a focal plane 206. Each camera has a back focal length f, and the two cameras are separated by the baseline distance of 2h. The field of view of both cameras encompasses a scene including a foreground object 408 and a background object 410. The scene from the viewpoint of the first camera 400 is illustrated in FIG. 4B. In the image 450 captured by the first camera, the foreground object 408 appears located slightly to the right of the background object 410. The scene from the viewpoint of the second camera 402 is illustrated in FIG. 4C. In the image 452 captured by the second camera, the foreground object 408 appears shifted to the left hand side of the background object 410. The disparity introduced by the different fields of view of the two cameras 400, 402, is equal to the difference in location of the foreground object 408 between its location in the image captured by the first camera (indicated in the image captured by the second camera by ghost lines 454) and its location in the image captured by the second camera. As is discussed further below, the distance from the two cameras to the foreground object can be obtained by determining the disparity of the foreground object in the two captured images.
Referring again to FIG. 4A, the point (xo, yo, zo) on the foreground object will appear on the focal plane of each camera at an offset from the camera's optical axis. The offset of the point on the focal plane of the first camera 400 relative to its optical axis 412 is shown as âuL. The offset of the point on the focal plane of the second camera 402 relative to its optical axis 414 is shown as uR. Using similar triangles, the offset between the images captured by the two cameras can be observed as follows:






h
-

x
o



z
o


=


-

u
L


f









h
+

x
o



z
o


=


u
R

f









h
-

x
o



z
o


=


-

u
L


f









h
+

x
o



z
o


=


u
R

f





Combining the two equations yields the disparity (or parallax) between the two cameras as:





Î
parallax

=



u
R

-

u
L


=


2
â¢
hf


z
o







From the above equation, it can be seen that disparity between images captured by the cameras is along a vector in the direction of the baseline of the two cameras, which can be referred to as the epipolar line between the two cameras. Furthermore, the magnitude of the disparity is directly proportional to the baseline separation of the two cameras and the back focal length of the cameras and is inversely proportional to the distance from the camera to an object appearing in the scene.
Occlusions in Array Cameras
When multiple images of a scene are captured from different perspectives and the scene includes foreground objects, the disparity in the location of the foreground object in each of the images results in portions of the scene behind the foreground object being visible in some but not all of the images. A pixel that captures image data concerning a portion of a scene, which is not visible in images captured of the scene from other viewpoints, can be referred to as an occluded pixel. Referring again to FIGS. 4B and 4C, when the viewpoint of the second camera is selected as a reference viewpoint the pixels contained within the ghost lines 454 in the image 452 can be considered to be occluded pixels (i.e. the pixels capture image data from a portion of the scene that is visible in the image 452 captured by the second camera 402 and is not visible in the image 450 captured by the first camera 400). In the second image, the pixels of the foreground object 408 can be referred to as occluding pixels as they capture portions of the scene that occlude the pixels contained within the ghost lines 454 in the image 452. Due to the occlusion of the pixels contained within the ghost lines 454 in the second image 452, the distance from the camera to portions of the scene visible within the ghost lines 454 cannot be determined from the two images as there are no corresponding pixels in the image 450 shown in FIG. 4B.
As is discussed further below, increasing the number of cameras capturing images of a scene from different viewpoints in complimentary occlusion zones around the reference viewpoint increases the likelihood that every portion of the scene visible from the reference viewpoint is also visible from the viewpoint of at least one of the other cameras. When the array camera uses different cameras to capture different wavelengths of light (e.g. RGB), distributing at least one camera that captures each wavelength of light in the quadrants surrounding a reference viewpoint can significantly decrease the likelihood that a portion of the scene visible from the reference viewpoint will be occluded in every other image captured within a specific color channel. The distribution of color filters in array cameras to reduce the likelihood of occlusions in accordance with embodiments of the invention is discussed further in U.S. Provisional Patent Application Ser. No. 61/641,164 entitled âCamera Modules Patterned with Ï Filter Groupsâ, to Nisenzon et al., filed May 1, 2012, the disclosure of which is incorporated herein by reference in its entirety.
Using Disparity to Generate Depth Maps in Array Cameras
Array cameras in accordance with many embodiments of the invention use disparity observed in images captured by the array cameras to generate a restricted depth of field depth map. A depth map is typically regarded as being a layer of meta-data concerning an image that describes the distance from the camera to specific pixels or groups of pixels within the image (depending upon the resolution of the depth map relative to the resolution of the image). Array cameras in accordance with a number of embodiments of the invention use depth maps for a variety of purposes including (but not limited to) generating scene dependent geometric shifts during the synthesis of a high resolution image and/or performing dynamic refocusing of a synthesized image.
Based upon the discussion of disparity above, the process of determining the depth of a portion of a scene based upon pixel disparity is theoretically straightforward. When the viewpoint of a specific camera in the array camera is chosen as a reference viewpoint, the distance to a portion of the scene visible from the reference viewpoint can be determined using the disparity between the corresponding pixels in some or all of the images captured by the camera array. In the absence of occlusions, a pixel corresponding to a pixel in the image captured from the reference viewpoint will be located in each image along an epipolar line (i.e. a line parallel to the baseline vector between the two cameras). The distance along the epipolar line of the disparity corresponds to the distance between the camera and the portion of the scene captured by the pixels. Therefore, by comparing the pixels in the captured images that are expected to correspond at a specific depth, a search can be conducted for the depth that yields the pixels having the highest degree of similarity. The depth at which the corresponding pixels in the captured images have the highest degree of similarity can be assumed to be the most likely distance between the camera and the portion of the scene captured by the pixel. Similar processes can be utilized when synthesizing a depth map from a virtual viewpoint.
Many challenges exist, however, in determining an accurate depth map using the method outlined above. In several embodiments, the cameras in an array camera are similar but not the same. Therefore, characteristics including (but not limited to) optical characteristics, different sensor characteristics (such as variations in sensor response due to offsets, different transmission or gain responses, non-linear characteristics of pixel response), noise in the captured images, and/or warps or distortions related to manufacturing tolerances related to the assembly process can vary between the images reducing the similarity of corresponding pixels in different images. In addition, super-resolution processes rely on sampling diversity and/or aliasing in the images captured by an imager array in order to synthesize higher resolution images. However, increasing sampling diversity can also involve decreasing similarity between corresponding pixels in captured images in a light field. Given that the process for determining depth outlined above relies upon the similarity of pixels, the presence of photometric differences and sampling diversity between the captured images can reduce the accuracy with which a depth map can be determined.
The generation of a depth map is further complicated by occlusions. As discussed above, an occlusion occurs when a pixel that is visible from the reference viewpoint is not visible in one or more of the captured images. The effect of an occlusion is that at the correct depth, the pixel location that would otherwise be occupied by a corresponding pixel is occupied by a pixel capturing another portion of the scene (typically an object closer to the camera). The occluding pixel is likely very different to the occluded pixel. Therefore, a comparison of the similarity of the pixels at the correct depth is less likely to result in a significantly higher degree of similarity than at other depths. Effectively, the occluding pixel acts as a strong outlier masking the similarity of those pixels, which correspond. Accordingly, the presence of occlusions can introduce a strong source of error into a depth map and processes for determining depth maps such as those disclosed in U.S. Patent Application Ser. No. 61/691,666, incorporated by reference above, involve detecting occlusions and determining depths using non-occluded pixels. Systems and methods for generating restricted depth of field depth maps in accordance with embodiments of the invention are discussed further below.
Synthesizing Images Using Restricted Depth of Field Depth Maps
When synthesizing an image using image data captured from different viewpoints in a manner similar to that conceptually illustrated in FIG. 4A, a focal depth 416 can be defined with an associated range of in-focus depths 418. The plane of best focus and range of in-focus depths can be utilized to determine a depth search that can be performed in such a way that depth is estimated with a lower precision at depths outside the range of in-focus depths in an L0 (highest resolution) depth map. Additional depth maps can be determined with respect to a pyramid of images generated by downsampling the captured images (e.g. L1, L2, etc. images). The depth maps of these lower resolution images can involve determining depth with greater precision at depths outside the range of in-focus depths than the precision of the L0 depth estimates at the corresponding depths. Accordingly, the precision of the depth information available in the L0 depth map may be reduced at depths in the out-of-focus region and the spatial resolution of the L1, and lower resolution depth maps in the out-of-focus regions is lower despite higher precision. Therefore, a single depth map can be constructed by first searching for the depth of a pixel in the L0 image and using the depth in an L1 or lower spatial resolution depth map (e.g. L2, L3, etc.) depending upon the depth of the pixel in the L0 image (and the depth of the pixel location in other higher levels, e.g. L2, L3, etc., within the depth map pyramid). It is worth noting that the spatial resolution of the depth map is often indicated by the descending indices of the depth maps, with increasing indices indicating decrease spatial resolution (i.e. L0 is higher spatial resolution than L1, L2, etc. and L2 is lower spatial resolution than L0, and L1). In other embodiments, a low spatial resolution depth map can be constructed and the low spatial resolution depth map used to determine when to perform a depth search with respect to a specific pixel or pixels that have a depth in the next-lowest or a lower level depth map (i.e. a higher spatial resolution depth map) that is within the in-focus depth range or outside the subset of the out-of-focus range mapped to the current level of spatial resolution. In several embodiments, depth is determined by performing uniform depth sampling with respect to disparity irrespective of whether the disparity corresponds to a range of in-focus or out-of-focus depths. In this way, a coarse precision disparity search can be performed using lower resolution images and the precision of the disparity search increased as disparity searches are performed with respect to pixels from higher spatial resolution images. In a number of embodiments, the depth estimates from coarse precision disparity searches can be used to identify pixels that are likely to be in-focus and modify and/or bound a higher precision disparity search for in-focus pixels, where the higher precision disparity search is performed using pixels from the higher spatial resolution images. The disparities searched using the higher spatial resolution images can be predetermined based upon the coarse precision disparity estimate for the pixel. In several embodiments, the disparities searched using the higher spatial resolution images are determined based upon the coarse precision disparity estimates of pixels within the neighborhood of the pixel.
As is discussed further below, a best focus depth can be defined based upon the distance of an object within a region of interest from the array camera. In the embodiment illustrated in FIG. 4A, the desired best focus depth 416 is determined to be the distance from the array camera to the foreground object 408. The depths which are considered in-focus 418 can then be determined relative to the best focus depth in any of a variety of ways appropriate to the requirements of a specific application. In several embodiments, the range of depths which are considered in focus is automatically determined based upon a synthetic aperture parameter provided to the pipeline which specifies how much blur should be applied for objects which are increasing distances from the best focus depth. For example, a setting to mimic F2.8 will result in more blur at a particular distance from the best focus depth than will a setting for F5.6 at the same distance. In other embodiments, the range of in-focus depths can be dependent based upon factors including (but not limited to) the content of the scene and user input. The observed disparity and depth of field associated with an object located at specific focal depths (object distances) is illustrated in FIG. 5. As can readily be appreciated by reviewing the curve of pixel disparity with respect to object distance in FIG. 5, the precision with which object distance can be determined decreases rapidly with increased object distance. In addition, the range of depths which are in focus increases as the best focus distance increases. As one can see, at a focal depth of 30 cm, the range of depths in focus is much smaller than if the desired best focus depth is set to a farther distance such as 10 meters.
In several embodiments, the array camera automatically identifies regions of interest within a scene and determines an appropriate focal depth. In one embodiment, the confident pixels in the region of interest can be determined by calculating edge gradients within the same region of interest in the reference image and selecting pixels as confident which have edge gradients that are stronger than a particular threshold. In several embodiments, the map of confident pixels in the depth map of the region-of-interest can be determined using any metric indicating the reliability of specific depth measurements within the region of interest. In one embodiment, an SNR estimator is applied to the reference image (within the region-of-interest), and pixels which are determined to have high SNR relative to a known or characterized noise floor or otherwise with respect to a threshold are deemed confident and likely to have reliable depth estimates. In certain embodiments, edge maps can also be generated and confident pixels that lie on edges can be utilized to determine depth. Once the pixels with confident depths within the region of interest are marked, a histogram is formed which counts how many of these confident pixels in the region of interest belong to each possible depth. From the resulting histogram, the desired focal depth can be selected using statistical measures or other measures applied to the histogram. In one embodiment, the depth which is confident and occurs most frequently in the region of interest (i.e. the mode of the histogram) is selected as the desired best focal plane. In many embodiments, temporal hysteresis can be utilized to control the extent to which the desired best focal plane and/or range of in-focus depths changes from one frame of video to the next. In several embodiments, time based filtering of the best focal plane and/or range of in-focus depths is utilized to smooth transitions between different best focal planes and/or ranges of in-focus depths during the capture of video using an array camera. In several embodiments, the damping of the rate of temporal change of the desired best focal point is a function of the number of confident depth measurements within the region of interest. If the number of confident pixels within the region is low, the resulting âbest focus depthâ may be discarded or may influence the temporal hysteresis by a discounted amount to avoid introducing spurious temporal changes in the best focal point due to low-confidence depth measures. In an alternate embodiment, depth information for pixels within the region of interest can be used in any of a variety of ways to select a best focal plane including (but not limited to) selecting the depth which appears as the median of the histogram distribution as the desired focal depth. In several embodiments, a user can specify one or more regions of interest containing objects from which a focal depth can be determined. In a number of embodiments, the user is provided with the ability to modify the plane of best focus and/or the range of in-focus depths utilized by the array camera to synthesize images from image data captured by the array camera. In many embodiments, a plane of best focus and an in-focus range of depths are selected, and these are utilized to synthesize video or still image data in real or near-real time and the raw image data can be reprocessed post capture to generate video sequences having different planes of best focus and ranges of in focus depths including (but not limited to) synthesizing all in focus images. In many embodiments, the raw image data can be processed post capture to generate a higher resolution depth map and/or a restricted depth of field depth map in which pixels that sample objects at different depths are uniformly processed (i.e. the process for determining the depth of a given pixel is not determined in a depth dependent manner).
A process for synthesizing images from image data captured by array cameras using restricted depth of field depth maps to reduce computation and provide a synthetic depth of field effect in accordance with an embodiment of the invention is illustrated in FIG. 6. The process 600 includes capturing (602) image data using multiple active cameras within an array camera. A selection is made (604) of a desired plane of best focus and based on a parameter provided to the pipeline which specifies how blur should be increased with distance from the best focus point, the ranges of depths which are considered âin-focusâ and âout-of-focusâ can be determined. As was noted above, pixels at the transition between âin-focusâ and âout-of-focusâ depths can be treated in a similar manner to âin-focusâ pixels to reduce artifacts associated with incorrect depth estimates. As is described further below, the selection can be made based upon direct user input (e.g. using a manual slider user interface element) and/or based upon an automatic determination of a relevant object distance. A process similar to the processes described in U.S. Patent Application Ser. No. 61/691,666, incorporated by reference above, can be used to detect disparity associated with parallax between viewpoints of the active cameras in the array. By controlling the manner in which disparity searches are performed, a restricted depth of field depth map which incorporates depth values drawn from different spatial resolutions and/or searches of varying precision which take into account relaxed rendering constraints to reduce computational requirements can be generated (606) in accordance with embodiments of the invention. The depth maps can include multiple levels. At the highest resolution level L0 the depth map can be determined using a lower precision at depths outside the range of in-focus depths. Lower resolution depth maps can include higher precision depth estimates at depths outside the range of in-focus depths determined with a lower spatial resolution. The depth estimate utilized at a specific object depth can be determined using any of a variety of factors that are discussed further below.
Restricted depth of field depth maps in which precision of depth estimation and/or spatial resolution vary that are generated in accordance with embodiments of the invention can be utilized to synthesize images from the captured image data. In several embodiments, a restricted depth of field depth map in which precision of depth estimation and spatial resolution vary is used to render (608) pixels that sample objects located at depths outside of the selected depth of field (out-of-focus regions). The restricted depth of field depth map can then be used to perform super-resolution processing (610) with respect to pixels that sample objects located within the selected depth of field (in-focus regions). The rendered pixels (608) and the pixels synthesized using super-resolution processes (610) can then be composited (612) to produce the final synthesized image. Out-of-focus regions are intentionally rendered to be blurry, and so an image is formed in these regions can use less computationally complex techniques and/or contributions from fewer cameras than are used in the in-focus region. In many embodiments, out-of-focus regions can be rendered using pixels from the pyramid of images generated by downsampling the captured images (e.g. L1, L2, etc. images). In certain embodiments, the number of levels of the pyramid of images used to generate the restricted depth of field depth map is different from the number of levels of the pyramid of images used to render the out-of-focus regions of the image. For example, two levels (e.g. L0 and L1) of the pyramid of images can be utilized to generate the restricted depth of field depth map and three levels (e.g. L0, L1 and L2) can be utilized to render the out-of-focus regions of the image. As can readily be appreciated, any number of levels of a pyramid of images generated by downsampling the captured images can be utilized to generate a restricted depth of field depth map and/or to render out-of-focus regions of an image as appropriate to the requirements of specification applications in accordance with embodiments of the invention. In in-focus regions, the provided restricted depth of field depth map has higher resolution and this is used for super-resolution processing to achieve increased sharpness compared to the out-of-focus regions. In the composited image, pixels in in-focus regions that sample objects located within the selected depth of field are super-resolved.
In many embodiments, the process illustrated in FIG. 6 can be repeated with sets of image data to synthesize a sequence of video frames that can then be encoded and stored. In many embodiments, the raw image data is also stored and/or compressed for storage. In this way, the raw image data can be used to synthesize additional images and/or video sequences utilizing alternative viewpoints, focal depths and/or depths of field. Although specific processes for synthesizing images from image data captured by array cameras using restricted depth of field depth maps to render a synthetic depth of field effect within a selected depth of field are described above with respect to FIG. 6, any of a variety of processes can be utilized to synthesize images from image data captured by array cameras using restricted depth of field depth maps in accordance with embodiments of the invention. Image processing pipelines that can be implemented in the software of an array camera in order to synthesize images from image data captured by the array camera using restricted depth of field depth maps to provide synthetic depth of field effects within selected depths of field are discussed below.
Varying Depth Estimation Precision Image Processing Pipeline
An image processing pipeline that can be implemented using an image processing application or a video processing application configured to execute on a processor within an array camera is illustrated in FIG. 7. The image processing pipeline 700 receives low resolution image data and performs normalization (702) on the low resolution image data. In several embodiments, the normalization involves performing photometric and/or geometric corrections with respect to image data received from different cameras in the array camera module. Photometric differences and scene-independent geometric distortions can be corrected through calibration. Photometric calibration data used to perform photometric normalization and scene-independent geometric corrections that compensate for scene-independent geometric distortions can be generated using an off line calibration process and/or a subsequent recalibration process. The photometric calibration data can be provided to a photometric normalization module or process that can perform any of a variety of photometric adjustments to the images captured by an array camera including (but not limited to) Black Level calculation and adjustments, vignetting correction, and lateral color correction. In several embodiments, the photometric normalization module also performs temperature normalization. The scene-independent geometric corrections determined using a calibration process can also be applied to the captured images to increase the correspondence between the images. When the captured images are used to synthesize a higher resolution image using super-resolution processing, the scene-independent geometric corrections applied to the images are typically determined at a sub-pixel resolution. Accordingly, the scene-independent geometric corrections are typically determined with a higher degree of precision than the corrections utilized during registration in conventional stereoscopic 3D imaging. In many embodiments, the scene-independent geometric corrections also involve rectification to account for distortion and rotation of the lenses of the array camera relative to the focal planes so that the epipolar lines of the alternate view images are easily aligned with those of the image captured from the reference viewpoint. By normalizing geometrically in this way, the searches performed to determine the depths of corresponding pixels can be simplified to be searches along straight lines in various cameras, and the precision of depth measurements can be improved.
The image processing pipeline 700 can perform focus detection and varying depth estimation precision parallax detection 704. As is described further below varying depth estimation precision parallax detection processes can involve performing disparity searches with greater precision at depths which are to be rendered in-focus. In addition, the varying depth estimation precision parallax detection process can involve filtering and downsampling captured image data to reduce the resolution of the image data. Lower spatial resolution disparity searches can then be performed with respect to the downsampled image data to produce one or more low resolution depth maps. Where the varying depth estimation precision parallax detection process involves generating multiple depth maps, the image processing pipeline 700 can composite the depth maps to produce a single restricted depth of field depth map which combines estimates from multiple levels of spatial resolution and/or precision of depth estimation that can be used to synthesize the final rendered image.
A restricted depth of field depth map can then be used to synthesize a high resolution image from the low resolution image data received by the image processing pipeline 700. The process of synthesizing a high resolution image can involve compositing 706 pixels from different viewpoints that sample objects located outside the selected depth of field (out-of-focus regions) by applying scene dependent geometric corrections based upon pixel depth. Super-resolution processes can then be utilized to synthesize portions of a high resolution image corresponding to pixels that sample objects located within the selected depth of field (i.e. in in-focus regions). The super-resolution process can involve performing raw fusion 708 and pilot fusion 710 (i.e. combining pixels from individual cameras onto a higher resolution grid and filling in holes to form an initial estimate of the super-resolved image in preparation for additional processing and recovery). In many embodiments, additional super-resolution processing can be performed including processes similar to those described in U.S. patent application Ser. No. 12/967,807, incorporated by reference above, to achieve additional increases in resolution (potentially at the expense of additional computational complexity). In several embodiments, the low resolution image data can be produced in out-of-focus areas and used to generate out-of-focus parts of a high resolution image using a compositing mechanism as part of the post capture image processing. For in-focus areas additional super-resolution processes using restricted depth of field depth maps and portions of images from multiple cameras in the camera array may be used in order to obtain a final high resolution image.
The composited pixels (706) and the synthesized pixels (708, 710) in the synthesized image can then be post processed (712) to apply one or more filters to remove artifacts within the synthesized image associated with the image processing techniques utilized to synthesize the image. Color processing and gamma correction 714 can be applied to the synthesized image and sequences of images forming a sequence of video frames can be encoded 716 using any of a variety of well known video encoding techniques to reduce the maximum bitrate of the video stream output by the video processing pipeline 700. In many embodiments, out-of-focus pixels are blurred, therefore, any denoising and sharpening filter applied in the post processing 712 stage of the video processing pipeline 700 can be applied to the in-focus region(s) only. The final video frame can be generated through a color processing and gamma correction 714 stage of the video processing pipeline 700. The color correction matrix is computed per frame based on the histogram of the red, green and blue color channels, while the gamma correction function as well as the exposure compensation for the next frame is computed from luma information. To speed this process up, many embodiments of the invention use color information from lower spatial resolution images generated during the process of generating a restricted depth of field depth map 704. Flicker artifacts in color and exposure control can also be reduced by adding temporal hysteresis to the parameters.
Although specific image processing pipelines are described above with reference to FIG. 7, any of a variety of video processing pipelines involving the creation of restricted depth of field depth maps in which precision of depth estimation and spatial resolution vary can be utilized to provide synthetic depth of field effects when synthesizing images in accordance with embodiments of the invention. Processes for selecting pixels from the different images using the restricted depth of field depth map based upon the distance of a pixel from the plane of best focus in accordance with embodiments of the invention are discussed further below.
Determining Focal Depth and Depth of Field Using a Region of Interest
In many embodiments, the process of generating a restricted depth of field depth map involves definition of a best focus depth and the range of depths corresponding to the âin-focus region.â In several embodiments, the best focus depth and blur characteristics which define the range of in-focus depths is selected by the user (e.g., as an F# setting). A preview image can be generated and a user interface cue, such as (but not limited to) the overlay of a small box or target similar to a conventional auto-focus reticle, can be presented to the user. The user can indicate an object using the user interface cue to guide the determination of a selected focal depth. In many embodiments, a full resolution parallax detection process is performed within the region of interest of the reference image indicated by the user to generate a depth map and a confidence map. Although, in several embodiments, a lower resolution depth map is utilized to determine the plane of best focus. Measured depths at pixels deemed to be confident with the confidence map within the indicated region of interest can then be used to determine a focal depth. As noted above a confidence map can be generated utilizing processes similar to those described in U.S. Patent Application Ser. No. 61/691,666, which is incorporated by reference above. An appropriate range of in-focus depths can be determined based upon the plane of best focus depth and or based upon further instructions received from the user. In many embodiments, the process of selecting a focal depth can be automated. In several embodiments, a depth map of the preview image is utilized to identify objects close to the center of the field of view shown in the preview image. In a number of embodiments, a box or an outline of the edge of the object used to determine the plane of best focus depth can be overlaid over the preview image and the user can provide an indication of a different region of interest in the event that the user wishes to modify the focal depth.
A process for selecting a focal depth and a depth of field based upon a region of interest is illustrated in FIG. 8. The process 800 includes determining (802) a region of interest. As noted above, the region of interest can be determined based upon user input received, for example, via a touch screen display on which a preview image is shown and/or an automated process that detects objects within the field of view. Objects can be located within the region of interest based upon pixels for which depths are confident and the distance to the object from the array camera can be used to select (804) the desired best focus depth. A range of in-focus depths can be selected (806) in accordance with any of a variety of criterion appropriate to a specific application. In several embodiments, the range of in-focus depths is determined based upon distances corresponding to a (symmetrical) range of disparity on either side of the disparity corresponding to the desired best focus depth. The size of range of in-focus depths is a parameter, which can be modified based upon user input.
A process for determining the depths of objects within a region of interest in accordance with an embodiment of the invention is illustrated in FIG. 9. The process 900 includes generating (902) a depth map for the region of interest and (904) a confidence map. The depth map and a confidence map can be utilized to identify the depth of objects within the region of interest for which depth is estimated with confidence (i.e. a confidence exceeding a predetermined threshold) that can be utilized to determine the depths of the objects and hence determine (906) an appropriate plane of best focus. In many embodiments, the plane of best focus can be determined to be the dominant depth of confident pixels located along intensity edges within the region of interest. In other embodiments, any of a variety of techniques can be utilized to select the desired best focus depth based upon the depths of pixels within a region of interest. In several embodiments, the determination of a plane of best focus and/or a restricted depth of field can be (optionally) utilized in determining (908) the image capture parameters that are utilized during image capture.
The mechanism of exposure provides adjustment of the device sensitivity to the light intensity in the scene. This is in part motivated by the limited dynamic range (ratio of highest to lowest light intensity) of the camera system compared to the dynamic range of intensities in the real world. In an image capture device, a metering and auto-exposure algorithm finds optimal values for the above parameters (some of these parameters may be specified or fixed). An auto-exposure algorithm aims to find the optimal exposure settings for the camera system by modifying a subset of the following parameters: exposure time, iris/lens aperture, sensor gain, and the use of neutral density filters. Auto-exposure algorithms may rely on external light meters/sensors or may evaluate optimal exposure time through the lens by successive image capturing as described above. In many legacy cameras auto-exposure algorithms run concurrently with image preview mode. Due to the fact that preview mode provides real time video, the auto-exposure algorithm is typically configured to make small adjustments in the exposure time since changes in exposure are immediately visible in the preview video. These small adjustments result in delays in identifying optimal exposure times. In a number of embodiments of the invention, a depth map is utilized to identify pixels within the restricted depth of field and the scene information obtained from the image data of the identified pixels is used to determine whether the image capture settings satisfy a set of predetermined criteria for parameters including (but not limited to) exposure, focus settings, shutter speed, aperture, and light sensitivity. In certain embodiments, an auto-exposure process performed based upon the image data of a subset of pixels with depths falling within the range(s) of distances corresponding to the restricted depth of field. In this way, the image capture parameters are determined based upon the pixels that are rendered at higher resolution. In many embodiments, processes are utilized that separately considers the impact of the image capture settings on pixels with depths within the range of distances corresponding to the restricted depth of field and for pixels with depths outside the range of distances corresponding to the restricted depth of field. For example, an initial set of image capture settings are determined based upon the pixels with depths within the range of distances corresponding to the restricted depth of field and then a verification process is performed to confirm that the image capture settings will not result in artifacts with respect to pixels with depths outside the range of distances corresponding to the restricted depth of field. As can readily be appreciated, any process that can be utilized in the determination of image capture settings can be applied to the subset of pixels with depths within the range of distances corresponding to the restricted depth of field and/or any verification process can be applied to confirm the image capture settings are appropriate to the overall scene as appropriate to the requirements of specific applications in accordance with embodiments of the invention.
A process for determining focal depth based upon depths of pixels located along intensity edges within a region of interest in accordance with an embodiment of the invention is illustrated in FIG. 10. The process 1000 includes counting (1002) the number of pixels located along intensity edges within the region of interest having specific depths or depths within specific ranges of depths. The focal depth can then be selected (1004) based upon the median pixel depth. In other embodiments, any of a variety of techniques can be utilized to determine focal depth based upon the depth of pixels located along edges within a region of interest.
The processes illustrated in FIGS. 9 and 10 can be understood with reference to FIGS. 11A-11D. A portion of an image constructed using image data captured by a Green reference camera in an array camera module in accordance with an embodiment of the invention is illustrated in FIG. 11A. The image portion 1100 includes a target 1102 defining a region of interest. A depth map of the region of interest shown in FIG. 11A is illustrated in FIG. 11B. Due to the resolution of the high resolution depth map 1104, the depth map contains a considerable amount of noise. The captured image 1100 can be utilized to generate the edge map 1106 shown in FIG. 11C. A histogram showing the depths of pixels within the edge map shown in FIG. 11C is illustrated in FIG. 11D. As noted above, any of a variety of techniques can be utilized to select a focal depth based upon the edge depth counts. In many embodiments, the median depth within the region of interest and/or of pixels along intensity edges within the region of interest is selected as the focal depth. In other embodiments, alternative criterion can be utilized to select focal depth based upon depth measurements of objects located within a region of interest as appropriate to the requirements of specific applications in accordance with embodiments of the invention.
Once a focal depth is determined, a depth of field can be automatically generated as described above and/or selected by the user. In many embodiments, focal depth is determined with respect to frames of video sequences captured by an array camera. Once a focal depth is determined based upon an edge and/or object in a first frame, object tracking can be utilized to determine focal depth for subsequent frames. Alternatively, a process for determining focal depth can be independently applied to each new set of frames in the set of video sequences. In many embodiments, time based filtering is applied to the focal depth to prevent rapid jumps in focal plane depth. In certain embodiments, focal plane depth information from one or more previous frames can be utilized to determine focal plane depth in a set of frames in which a distance to an intensity edge and/or object cannot be confidently determined. In this way, the automated process of determining a focal plane depth can leverage information from previously captured frames of video. Using the focal depth and the depth of field, a restricted depth of field depth map can be generated for image data captured by the array camera. Processes for generating restricted depth of field depth maps in accordance with embodiments of the invention are discussed further below.
Restricted Depth of Field Depth Maps
The process of generating a depth map is described in general above and in U.S. Patent Application Ser. No. 61/691,666, incorporated by reference above. The computational complexity of generating a depth map can be reduced in a variety of ways including (but not limited to) varying the resolution and/or precision of depth estimation of the depth map. The precision of depth estimation of a depth map for a given reference image can be varied by changing the sampling frequency of the depth range that objects in the scene span. The spatial resolution of the depth map can be varied by modifying the resolution of the areas within the reference image for which depth information is computed within the depth map. Processes for varying the precision of depth estimation of depth measurements and/or for varying the spatial resolution of the areas within the reference image for which depth information is obtained based upon whether pixels in a reference image sample an object within the scene that is located within a selected depth of field are discussed further below.
Varied Precision Depth Sampling
The process of determining depth using disparity between corresponding pixels in image data captured by a reference camera and an alternate view camera can involve searching (i.e. performing comparisons between a pixel from a reference image and pixels in an alternate view image) along an epipolar line. The number of depth samples (i.e. comparisons performed) taken along the epipolar line typically depends upon the array camera geometry and the camera baselines. An appropriate number of samples for a monolithic array camera can be in the order of 32 samples, but the number can change based upon quality criteria appropriate to the requirements of a specific application as well as the particular design parameters for the array being considered. For example, the number of depth samples taken along the epipolar line can depend on the size of the baselines, focal length, pixel size, number of cameras in the array, desired nearest resolvable depth, and the targeted super-resolution factor. In one embodiment, the depth samples are evenly distributed in disparity, which means that the samples are spaced the same distance apart along the epipolar line (which does not correspond to samples being taken at uniform object distances). For example, referring to the disparity relationship with respect to object distance measured for the array camera illustrated in FIG. 5, a maximum disparity of 40 pixels is observed at an object distance of 20 cm (i.e. the minimum focal distance for the array camera). Dividing the maximum disparity of 40 pixels by 32 samples suggests sampling every 1.25 pixels along the epipolar line from the minimum anticipated disparity, which in the case of the array camera illustrated in FIG. 5 is 0.8 pixels at infinity. Therefore, depth samples can be performed initially at 0.8 pixels along the epipolar line, and then at 2.05, 3.3, etc. up to 40 pixels. As can readily be appreciated, reducing the number of depth samples (a technique for reducing depth estimation precision) reduces the number of computations needed to generate the depth map. In many embodiments, selection of a desired best focus depth and a limited range of in-focus depths enables one to limit higher density depth sampling to only occur within the in-focus regions and allows lower density depth sampling in the range of out-of-focus depths.
A process of determining the precision of depth searches by performing higher density depth samples within a selected range of disparities corresponding to a range of in-focus depths can be appreciated with reference to FIG. 12. The disparity along the epipolar line 1200 corresponding to a selected desired depth of best focus 1202 can be determined as can the range of disparities along the epipolar line corresponding to a selected range of in-focus depths 1204. Disparities corresponding to a foreground range of out-of-focus depths (1206) and a background range of out-of-focus depths (1208), which are both outside of the range of in-focus depths (1204), can be determined. In several embodiments, the density with which depth samples are taken can be greater within the range of in-focus depths than within the foreground and background (i.e. the range of disparities corresponding to out-of-focus depths). Consequently, the depth map can be considered to have different precisions of depth estimation within the range of disparities corresponding to in-focus and out-of-focus ranges. As discussed further below, the reduced computational complexity of performing a depth search along the epipolar line results in increased blur or lack of sharpness for pixels that image objects within the out-of-focus regions of the scene. In many embodiments, the density of depth sampling is gradually increased and decreased in the transition along the epipolar line between disparities corresponding to depths that are bordering the ranges of in-focus and out-of-focus disparities.
A process for performing a parallax detection search using different depth sample densities along an epipolar line based upon a selected focal depth and depth of field in accordance with an embodiment of the invention is illustrated in FIG. 13. The process 1300 includes selecting (1302) disparities to search within the in-focus region. The selected disparities can be uniformly distributed across the range of disparities within a range of in-focus depths or can be distributed with spacing that provides a smooth transition across disparities at the edges of the range of disparities corresponding to the in-focus region. Similarly, disparities to search within the disparity ranges corresponding to disparities outside the range of in-focus depths can also be determined (1304). By performing depth samples at the selected disparities, parallax can be detected (1306). In many embodiments, the disparities are selected in an offline process and are retrieved from memory based upon the selected focal depth and/or depth of field. In a number of embodiments, the disparities are selected during the synthesis of an image based upon the selected focal depth and/or depth of field.
The processes described above with reference to FIG. 13 can be understood with reference to FIGS. 14 and 15. Selection of uniform depth samples 1400 across the range of disparities corresponding to a selected depth of field is conceptually illustrated in FIG. 14. In many embodiments, rendering the in-focus region of an image involves placing pixels onto a higher level fusion grid and the precision with which depth is sampled is determined based upon the resolution of the higher level fusion grid. For example, super-resolution processes that increase resolution by a factor of two utilize a fusion grid with pixel spacing equivalent to 0.5 a low resolution pixel. Therefore, a disparity search with at least a 0.5 low resolution pixel resolution can be performed to generate a restricted depth of field depth map with sufficient precision to perform super-resolution processing of pixels that sample objects within the scene located within the selected depth of field. In many embodiments, the array camera estimates depth by performing depth samples at distances separated by a distance equal to or less than the size of a pixel multiplied by the inverse of a super-resolution factor by which the super-resolution process increases the resolution of the synthesized images relative to the resolution of the captured low resolution image data within a disparity range corresponding to the selected depth of field, and by performing depth samples at distances separated by a distance equal to more than the size of a pixel multiplied by the inverse of the super-resolution factor within disparity ranges outside the selected depth of field. Typically, the super-resolution ratio can be determined as the ratio of the resolution of the reference image data and resolution of the grid on which the synthesized image is formed within the selected depth of field of the image.
A lower density of depth sampling can be performed with respect to disparities corresponding to depths outside of the range of depths which are rendered in-focus. Selection of additional depth samples 1500 in a foreground region and a background region to smoothly transition between regions of the image containing objects within the depth of field and regions of the image that do not contain objects within the depth of field is illustrated in FIG. 15. In several embodiments, a minimum number of depth samples is performed in each of the regions outside of the depth of field to provide a threshold level of registration so that pixels from different color channels can be aligned with sufficient precision to reduce the incidence of color artifacts within the out-of-focus regions in a synthesized image. In other embodiments, any of a variety of factors can be utilized in selecting depth samples within disparity ranges corresponding to depths outside of a selected range of in-focus depths. Although specific depth sample selections involving depth samples that are evenly spaced with respect to disparity within the range of in-focus depths and are unevenly spaced with respect to disparity outside the range of in-focus depths are conceptually illustrated in FIG. 15, any of a variety of processes can be utilized to select depth samples to achieve a higher density of depth samples with respect to disparity within a selected restricted depth of field in accordance with embodiments of the invention. In many embodiments, processing efficiencies can be achieved by generating an initial depth map in which a coarse depth estimation precision is utilized. A determination can then be made as to which pixels are likely to image objects located at in-focus depths based upon the depth estimates in the initial depth map and higher precision depth estimates obtained for at least some of those pixels. In this way, the number of disparities searched for pixel locations that image objects located at out-of-focus depths can be reduced, reducing overall computation within the image processing pipeline.
Parallax Detection at Multiple Spatial Resolutions
The discussion of FIGS. 12-15 above describes how the number of depth samples used when generating a depth map can be reduced by reducing the number of depth samples searched with respect to disparities corresponding to object depths falling outside of a selected range of in-focus depths. Ideally, the out-of-focus regions possess smoothly increasing blur as distance from the focal depth increases. The smoothness of the transition is largely dependent upon the number of depth samples performed with respect to disparities corresponding to object depths falling outside of a selected range of in-focus depths. In many embodiments, computational efficiencies can be achieved when performing disparity searches with respect to pixels with disparities corresponding to object depths falling outside of a selected restricted depth of field by performing the depth searches at lower pixel resolutions. In several embodiments, these depth searches are performed by downsampling the captured image data and performing depth searches in these downsampled images. For example, a depth search in the manner described above can be performed with respect to the captured image data, a second depth search can be performed with respect to downsampled image data having a resolution of one quarter the resolution of the original image data, and a third depth search can be performed with respect to downsampled image data having a resolution of one sixteenth the resolution of the original image data. Alternatively, a depth search can first be performed with the downsampled image data and additional depth searches performed with the original image data (and/or downsampled but higher spatial resolution image data) based upon the initial coarse depth estimates obtained with the downsampled image data. In other embodiments, any number of depth searches involving any combination of downsampled image resolutions can be performed. The resulting depth information can be composited and the depth measurements in the composited depth map can provide higher precision compared to using only a few depth samples without incurring considerable computational overhead. By performing depth estimation using lower spatial resolutions in portions of the depth map corresponding to regions of a reference image that sample portions of the object space that lie outside of the selected depth of field, a greater number of disparities can be searched for a given computational budget. In this way, smoother transitions in blur can be obtained at a given computational load through multi-resolution image compositing in the out-of-focus regions of the synthesized image.
A process for generating a restricted depth of field depth map using different spatial resolution depth estimates in accordance with an embodiment of the invention is illustrated in FIG. 16. The process 1600 includes generating (1602) calibrated images by performing processes including (but not limited) to applying scene independent geometric corrections to the image data captured from different viewpoints to facilitate parallax detection using searches for corresponding pixels along epipolar lines. The calibrated image data can be down-sampled (1604) and then (portions of) depth maps generated (1606) at each resolution. The resulting (portions of) depth maps can then be composited (1608) to obtain a single restricted depth of field depth map for use in the synthesis of a higher resolution image.
In several embodiments, the finest spatial resolution depth map can be generated using the approach to varying precision of depth estimates when performing depth sampling described above. In other embodiments, the finest resolution depth map can be generated using depth samples that are uniformly distributed with respect to disparity. Similarly, depth maps with respect to down-sampled images can be generated using the approach to varying precision of depth estimates when performing depth sampling described above or using depth samples that are uniformly distributed with respect to disparity. Depth samples used to determine depth with respect to down-sampled pixels that are uniformly distributed with respect to disparity are conceptually illustrated in FIG. 17. In several embodiments, the low spatial resolution depth samples 1700 are selected to provide depth information at one or more depths that may or may not be sampled during the generation of a higher spatial resolution depth map. Combining these additional depth measurements from lower spatial resolution images with the sparsely sampled depth map at the highest image pyramid resolution, a final L0 level depth map can be constructed with additional precision than the sparsely sampled depth map alone. This increased precision obtained with only marginal computational overhead allows for gradual blur differences along smoother depth transitions in out-of-focus regions of the image. In the illustrated embodiment the depth samples are performed at disparities that are not uniformly distributed around the plane of best focus. In many embodiments, the depth samples are performed at disparities that are uniformly distributed around the plane of best focus.
Another process for assigning a depth measurement from a plurality of depth maps determined at different resolutions is illustrated in FIG. 18A. The process 1800 includes selecting (1802) a depth for a pixel location within a reference image from the high resolution depth map. A determination (1804) is made concerning whether the depth is within a selected depth of field. When the estimated depth is within the selected depth of field, the highest resolution depth map will provide the highest precision depth measurement and so the depth from the highest resolution depth map is used (1806) to populate the depth map for the selected pixel location in the reference image. When the depth is outside the selected depth of field where the disparity sampling density in the L0 level is sparse, the confidence of the depth estimate may be low. In such cases a lower resolution depth map (i.e. a depth map generated using down-sampled image data) is likely to contain a more accurate depth measurement and the depth of the pixel can be utilized to select the specific lower resolution depth map to use. Typically, the further the depth estimate for the pixel is from the depth in focus, the larger the desired level of blur for the pixel in the synthesized image. To obtain this effect, depth estimates of pixels with depths increasingly further from in-focus depth regions are composited from lower resolution images formed with larger downsampling factors. The depth measurement from the lower resolution depth map can then be assigned (1808) to the pixel location within the reference image.
In many embodiments, a confidence map quantifying the level of accuracy expected with the depth estimate at each pixel location is generated with respect to each of the depth maps within the pyramid of depth maps and these confidence maps can be utilized when selecting a depth to assign to a pixel.
In many embodiments, the computational complexity of generating a pyramid of depth maps at different resolutions can be reduced by eliminating the need to recalculate the depth at every pixel location. In many embodiments, this can be achieved by selectively propagating depth measurements from one or more lower spatial resolution depth maps to one or more higher spatial resolution depth maps. The selectivity criteria for propagating depths across one or more pyramid levels can be highly beneficial in speeding up the depth calculation process for finer precision of depth estimation and/or resolution pyramid levels without sacrificing accuracy of the depth estimates. In many embodiments, the selective criterion for propagating depths across pyramid levels is the depth estimate for a pixel and/or the (confident) depth estimates for pixels in a neighborhood surrounding a pixel. In other embodiments, the selective criterion can be based on the position of the pixel with respect to the amount of texture in the neighborhood. If a pixel lies in a region devoid of considerable high frequency content such as edge transitions or textures, we can classify the pixel to belong to a âtextureless regionâ of the image. In an embodiment, such regions can be identified by their low signal-to-noise ratio (SNR). There are typically a much larger number of such low SNR pixels in an image than the number of edge or texture pixels in an image. In the varying depth estimation precision framework described above, the reduction of noise in the coarser pyramid levels of the image data can lead to reduction of random variations in the corresponding depth estimates, especially in the textureless regions of a reference image. However, reducing variation does not necessarily imply a statistically more accurate estimate of depth (estimation variance may be exchanged for bias). Achieving a smoother depth map in flat areas, however, can provide for more localized data access patterns when performing super-resolution operations. Therefore, significant computational savings can be achieved by utilizing depth estimates obtained at a coarser resolution layer of a depth map pyramid as the depth estimates in a higher resolution depth map for pixels within regions of the higher resolution image that exceed a specific smoothness threshold.
A process for propagating depth estimates from coarser spatial resolution depth maps to higher spatial resolution depth maps based upon the values of the lower spatial resolution depth estimates in accordance with an embodiment of the invention is illustrated in FIG. 18B. The process 1820 includes downsampling (1822) captured image data to obtain at least one set of lower resolution images that can be used to perform (1824) a lower spatial resolution depth search. In many instances, the lower spatial resolution depth search is also a coarser precision depth search (i.e. larger steps in disparity along the epipolar line are searched than are performed in later higher spatial resolution depth searches). For each pixel in the restricted depth of field depth map, a decision (1826) is made using the lower spatial resolution depth estimates as to whether the pixel depth is within the in-focus range of depths. The decision can be based upon the depth and/or confidence of the lower spatial resolution depth estimate for the pixel location. In a number of embodiments, the decision is based upon the depth and/or confidence of the lower spatial resolution depth estimates of pixels in a neighborhood surrounding the pixel location. When a determination is made that a pixel is outside of the in-focus range of depths, then the lower spatial resolution depth estimate is propagated (1828) to the higher spatial resolution depth map. When a determination is made that a pixel is within the in-focus range of depths, then a higher spatial resolution depth search is conducted (1830). As noted above, pixels in a transition zone adjacent the desired depth of field can be treated as in-focus to reduce artifacts. Furthermore, other criteria including (but not limited to) the pixels being located within a textureless region of the image can be utilized to identify low spatial resolution depth estimates that can be utilized as the depth estimates for the same pixels in the higher spatial resolution depth map(s). In a number of embodiments, the higher spatial resolution depth search is also a higher precision depth search (i.e. the depth estimate is performed by searching narrower disparity intervals). In several embodiments, the higher spatial resolution depth search is accelerated by searching a bounded range or range(s) of disparities. The bounded range(s) can be determined based upon the depth and (optionally) confidence of the lower spatial resolution depth estimate for the pixel, or the depth and/or confidence of the lower spatial resolution depth estimates of pixels in a neighborhood surrounding the pixel location. A restricted depth of field depth map can be generated by combining the propagated lower spatial resolution depth estimates for pixels determined to have depths outside the in-focus range of depths and the higher spatial resolution depth estimates for pixels determined to have depths within the in-focus range of depths.
Depth sampling in a process that performs coarse depth estimates using a set of downsampled images and performs higher precision depth estimates using higher resolution images in a manner similar to that described above with respect to FIG. 18B is illustrated in FIGS. 18C and 18D. FIG. 18C conceptually illustrates a first coarse precision disparity search (optionally) performed using downsampled images. Based upon a determination concerning whether the pixel is within an in-focus range of depths, a higher precision disparity search is performed using the original resolution of the captured image data. A comparison of the disparities 1850 searched in FIG. 18C and the disparities searched in FIG. 18D reveals that the disparities 1850 illustrated in FIG. 18C are spaced further apart than the disparities 1860 illustrated in FIG. 18D. Although the disparities are shown as evenly spaced, non-uniform spacing can also be utilized in either disparity search. As noted above, the higher precision disparity search can be accelerated by seeding the search with the coarser precision depth estimate (e.g. 1862). Furthermore, the search can be bounded (e.g. 1864) based upon factors including (but not limited to) depth and/or confidence of the lower spatial resolution depth estimate for the pixel, or the depth and/or confidence of the lower spatial resolution depth estimates of pixels in a neighborhood surrounding the pixel location.
Although specific processes are described above with respect to FIGS. 18B-18D for generating a restricted depth of field depth map by generating an initial lower spatial resolution and/or coarser precision depth map, propagating depth estimates for pixels determined to image objects located at depths outside an in-focus range of depths, and generating higher spatial resolution and/or higher precision depth estimates for pixels within the in-focus range of depths, any of a variety of processes can be utilized to propagate depths from one or more lower spatial resolution and/or coarser precision depth map(s) to a higher spatial resolution and/or higher precision depth map to generate a restricted depth of field depth map in accordance with embodiments of the invention. A process for propagating depth estimates from lower spatial resolution and/or coarser precision depth maps to higher resolution and/or higher precision depth maps with respect to regions of an image satisfying a smoothness criterion in accordance with an embodiment of the invention is illustrated in FIG. 19.
The process 1900 illustrated in FIG. 19 includes identifying (1902) regions of the image in accordance with one or more smoothness criteria. In several embodiments, the smoothness criteria is designed to detect textureless regions. In a number of embodiments, any of a variety of criteria are used to select regions for which depth information is propagated in the manner outlined below. Depth estimates obtained from a downsampled version of the image are propagated (1904) into the higher resolution depth map for pixels within the identified regions of the image. The depths of pixels outside the selected regions are then determined (1906) and inserted into the higher resolution depth map.
Many of the depth propagation processes described above utilizes the ability to identify low SNR regions. This can be done for each resolution level (e.g., L0, L1, . . . , LN-1). The distribution of textureless regions within captured image data is typically scene dependent. Moreover, the level of noise in the image also influences the accurate identification of such regions. However, the noise level in any given pixel in the image can be, to some extent, estimated from a noise level curve that can be obtained from the calibration process of the array camera module. The noise level curve enables estimation of the noise variance for different intensity levels, given a certain analog gain (which corresponds to the light level in the scene). The estimated noise variance can guide selection of a threshold for classifying each pixel as positioned in a textured or textureless region.
Estimating the SNR at each pixel to identify the smooth regions can be computationally taxing for a real-time video image processing pipeline. Consequently, a threshold on the edge magnitude can be applied. In several embodiments, edge gradients in the horizontal and vertical directions are obtained from convolving the reference image with a low complexity edge detection kernel, such as a 3Ã3 Scharr operator. In other embodiments, any of a variety of approaches can be utilized to obtain information concerning edge magnitude. A conservative threshold can be selected to provide a low rate of false negatives (pixels identified as belonging to a textureless region when they actually do not). This reduces the likelihood that depths at finer edges of a finer resolution grid are populated from a coarser image as such edges may potentially not be present in the coarser resolution image leading to an erroneous depth estimate. Note that the decision of whether a particular depth is propagated to a finer resolution depth map can be based on the image gradient magnitude of the pixel intensity values of the finer as well as coarser resolution levels, while the depth estimate is obtained from one or more corresponding coarser resolution level in the depth map pyramid. In many embodiments, the decision can be based upon the depth and edge map of multiple corresponding levels in a pyramid of images and associated depth and edge maps.
In a particular implementation of the array camera, where a reference camera captures only a shallow range of light frequencies (for example, green color component only), the edge map from this limited scene information may not be adequate in ensuring accurate depths being propagated. Although not very prevalent, this may occur when two objects, one partially occluding the other in the line of vision of the reference camera, exhibit very similar signatures at frequencies which are captured by a reference camera, even though their actual colors can be considerably different (e.g. a green object on certain yellow backgrounds). If the reference camera captures predominantly green intensities, objects with a narrow range of intensity variation in the green channel may not be captured as an edge in the reference image despite possibly having a wider range of intensity variation in one or more other different color channels (e.g. red or blue). When identifying pixels for which depth need not be recalculated in the finer resolutions in a depth map pyramid, pixels that sample objects that have a narrow range of intensity variation in a single color channel can be incorrectly classified as low SNR regions for which depth will be propagated across pyramid levels. When depth is propagated across pyramid levels in the green channel in this manner, edges present in either (or both) of the red and blue color channels may not line up for these propagated depths during image synthesis, which can result in color bleeding and/or artifacts. As can readily be appreciated, similar effects can be observed in other color spaces. Additionally, pixels associated with such incorrect depths may lead to an unnatural level of blur, which can manifest visually as objectionable artifacts. In order to suppress such artifacts, the confidence of a depth estimate at a lower resolution can also be considered during propagation as an additional check to increase the likelihood that correct depths are propagated through to the finer resolution levels. Thus, in many embodiments, the depth for a pixel in the finer resolution is populated from a lower resolution grid when the pixel under consideration does not lie on or close to an edge, and when the depth being propagated has a high confidence, and this confidence map may take into account detections of possible regions that exhibit narrow intensity variation in some color channels but not in other color channels.
Using the mechanism outlined above, for any pyramid level (except the coarsest one), an image can be scanned to specify a mask of pixels for which the depth need not be recomputed. Depending on the scene content, and lighting conditions, the mask may not be very contiguous leading to a loss of parallelization (especially on an embedded platform). To further enhance speed, and retain the ability to translate and compute costs for a group of pixels at a time, the mask can be dilated so that the depth estimate for a group of pixels is computed or propagated from a lower resolution estimate. While this does reduce the number of pixels for which the depth needs to be recomputed, an overall gain in speed can be achieved through the ability to parallelize computations and lower memory reads.
Although various processes are described above for generating a restricted depth of field depth map using a pyramid of depth maps determined at different resolutions and/or by propagating depth estimates between the depth maps, any of a variety of processes for generating a restricted depth of field depth map providing depth information determined using different spatial resolutions and/or precisions can be utilized as appropriate to the requirements of specific applications in accordance with embodiments of the invention. In addition, while much of the above discussion references compositing of depth maps to create a restricted depth of field depth map incorporating smooth depth transitions, many embodiments of the invention utilize the pyramid of depth maps at different spatial resolutions and associated confidence maps (optionally) during image synthesis. Processes for synthesizing images using restricted depth of field depth maps in accordance with embodiments of the invention are discussed further below.
Synthesizing Images Using Restricted Depth of Field Depth Maps
A restricted depth of field depth map and/or pyramid of depth maps generated using the techniques discussed above can be used to generate a synthesized image with a high resolution in-focus region and blurry out-of-focus regions. The level of blur can mimic the behavior of a chosen F-stop or may implement an arbitrary blur profile (e.g. a blur characteristic that may not be physically realizable by a traditional camera architecture). Referring again to the process 600 illustrated in FIG. 6, an image can be synthesized by rendering (608) pixels with depths outside of a selected restricted depth of field and performing super-resolution processing (610) with respect to pixels with depths within the selected restricted depth of field. The rendered pixels (608) and the pixels synthesized through super-resolution processing (610) are composited (612) to obtain an image. In several embodiments, pixels in the out-of-focus regions of the image are rendered using scene dependent geometric corrections based upon depth information of each pixel and the distance of the object sampled by the pixel from a selected focal depth. The further the distance, the coarser the image data resolution levels used to render the pixel. In this way, successively higher levels of blur with distance from the selected focal depth are achieved in the rendering of pixels in the out-of-focus regions of an image. In many embodiments, the process of rendering a pixel involves blending one or more down-sampled versions of the pixel to increase the smoothness of blur within the out of focus regions.
A process for rendering a pixel in an out-of-focus region of a synthesized image in accordance with an embodiment of the invention is illustrated in FIG. 20. The process 2000 includes selecting pixels for rendering and interpolating (2002) the selected pixels with corresponding pixels in one or more down-sampled images based upon the depth of the pixel to obtain updated pixel values. A deblocking filter can be applied (2004) to the updated pixel values to reduce blockiness resulting from the interpolation and the updated pixel values are placed (2006) in appropriate pixel locations in the synthesized high resolution image using scene dependent geometric corrections determined based upon the depths of the updated pixels.
The above process can be considered in the context of pairs of pyramid levels, where the first step is to divide the entire range of sampled depths into discrete levels of blur, based on the range of the in-focus depths. In keeping with the intention to have gradually increasing blur for pixels with increasing distance from the in-focus depth range, the in-focus region is associated with the highest resolution of the image data pyramid. The in-focus depth range divides the entire range of depths sampled into a foreground and background region. In each region, level of detail mappings are constructed to associate depth planes with particular blur levels. The number of such mappings is dependent on the number of pyramid levels selected and the amount of blur in out-of-focus regions desired based on the desired synthetic aperture as well as the method used to blur the original pyramid. Typically the step size between depth planes mapping to adjacent blur levels is constant in disparity space (but not in actual distance space). Blurry pixels in out-of-focus regions can then be synthesized using one or more pixels from adjacent image data pyramids, where the image data pyramids are selected based on the depth of the pixel to be synthesized and the blur level mapping. In one particular embodiment, the blending function used can be trilinear interpolation.
Each lower resolution pixel can correspond to a number of (say nÃn) pixels in the next finer resolution image, where n is a function of the decimation factor used to generate the image data pyramids. As a result, the newly updated image pixels can have some blockiness. To smoothen out such artifacts, a deblocking filtering process such as (but not limited to) Gaussian filtering can be performed on pixels that are updated in the compositing stage. In a particular embodiment, this process can be performed between the two coarsest pairs of pyramid levels using the corresponding levels from the depth map pyramid based on the level of detail mappings. This can then be repeated for each consecutive pair of pyramid levels, leading to the highest resolution mimicking the target reduced depth of field image at camera resolution. In another embodiment, only one (typically the finest resolution) depth map is used to select the pair of pyramid levels to blend and synthesize each input camera resolution pixel based on its depth and level of detail mapping.
In a particular embodiment where each camera of the camera array samples only a filtered version (typically red, green or blue color filters are used although in other embodiments array cameras sample other color spaces including but not limited to color spaces that image outside of the visible light spectrum) of the input light, and the reference camera does not contain enough information to synthesize the full color image, âvirtualâ reference images can be formed prior to the compositing process outlined above. To generate the full color image data pyramid needed for compositing, one or more image pyramids from non-reference cameras, encompassing the different color components captured by the image array but not sampled by the reference camera can be generated. Using the depth maps for different pyramid levels, these non-reference images are geometrically warped to synthesize each missing color component pyramid levels from the viewpoint of a reference camera. Alternatively, this process can be used to generate a high resolution virtual reference images that can be generated and the virtual reference images blurred and downsampled from each of the virtual reference pyramid levels. In a particular embodiment, this warping mechanism is the same as used in raw fusion (described in U.S. patent application Ser. No. 12/967,807), but with a scaling factor of 1 for each pyramid level. Compositing is then performed for these âvirtualâ color components, typically in the same way as that of the reference image data pyramid, to form the full color reduced depth of field synthetic image.
Although various processes for rendering pixels from out-of-focus regions of a reference image are described above, any of a variety of processes for compositing pixels from out-of-focus regions of a reference image can be utilized as appropriate to the requirements of a specific application in accordance with embodiments of the invention. Systems and methods for using super-resolution processes to synthesize pixels within in-focus regions within a synthesized image in accordance with embodiments of the invention are discussed further below.
Super-Resolution Processing of Pixels within Depth of Field
Where a restricted depth of field depth map indicates that a pixel in a reference image is located within a selected in-focus depth of field, super-resolution processing can be utilized to place the pixel from the reference image on a high resolution grid for the synthesized image and to place pixels from image data captured from alternate viewpoints onto the high resolution grid to increase the overall resolution of in-focus regions of the synthesized image. A process for performing super-resolution processing in accordance with an embodiment of the invention is illustrated in FIG. 21. The process 2100 includes performing (2102) fusion of the raw camera data (henceforth called raw fusion) to place unoccluded pixels from the image data captured by the array camera onto the target high resolution grid based upon the scene dependent geometric corrections determined using the restricted depth of field depth map and/or any occlusion maps determined during the creation of the restricted depth of field depth map. The raw fusion creates a high resolution grid in which holes are likely to exist in various pixel locations. An additional pilot fusion process is then performed (2104), which fills the holes on the high resolution grid. A post sharpening process can also be applied that includes processes to enhance the synthesized image including (but not limited to) smoothing images along edges and sharpening the image perpendicular to edges. In a number of embodiments, the output of the pilot fusion process is utilized as an input to a super-resolution process that iteratively estimates higher resolution image data based upon information including (but not limited to) the image data captured by the array camera and/or an imaging prior. Systems and methods for performing iterative super-resolution processes in accordance with an embodiment of the invention are also described in U.S. patent application Ser. No. 12/967,807, incorporated by reference above.
Various processes for performing raw fusion and pilot fusion are described in U.S. patent application Ser. No. 12/967,807, incorporated by reference above. In other embodiments, any of a variety of processes for fusing pixel intensity from image data captured from various viewpoints onto a high resolution grid and/or for performing super-resolution processing can be utilized in accordance with embodiments of the invention. Furthermore, any of a variety of filtering techniques appropriate to the requirements of specific applications can be applied to the composited pixel information on the high resolution grid to achieve desired image sharpness within the in-focus region of the synthesized image and smooth transitions in blur of out-of-focus regions.
While the above description contains many specific embodiments of the invention, these should not be construed as limitations on the scope of the invention, but rather as an example of one embodiment thereof. It is therefore to be understood that the present invention may be practiced otherwise than specifically described, without departing from the scope and spirit of the present invention. Thus, embodiments of the present invention should be considered in all respects as illustrative and not restrictive. Accordingly, the scope of the invention should be determined not by the embodiments illustrated, but by the appended claims and their equivalents.